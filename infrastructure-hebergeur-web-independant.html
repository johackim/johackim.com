<!DOCTYPE html><html lang="fr"><head><meta charSet="utf-8" data-next-head=""/><meta name="viewport" content="width=device-width" data-next-head=""/><meta name="twitter:card" content="summary_large_image" data-next-head=""/><meta name="twitter:site" content="@_johackim" data-next-head=""/><meta name="twitter:creator" content="@_johackim" data-next-head=""/><meta property="og:url" content="https://johackim.com" data-next-head=""/><meta property="og:locale" content="fr_FR" data-next-head=""/><meta property="og:site_name" content="johackim" data-next-head=""/><title data-next-head="">Mon infrastructure en tant qu&#x27;hébergeur web indépendant | Johackim - Hacker indépendant</title><meta name="robots" content="index,follow" data-next-head=""/><meta name="description" content="En tant que membre des CHATONS (Collectif des Hébergeurs Alternatifs, Transparents, Ouverts, Neutres et Solidaires) et étant seul à maintenir les services de mes clients, je me suis conçu une infrastructure sécurisée, performante, scalable, automatisée et facile à maintenir." data-next-head=""/><meta property="og:title" content="Mon infrastructure en tant qu&#x27;hébergeur web indépendant" data-next-head=""/><meta property="og:description" content="En tant que membre des CHATONS (Collectif des Hébergeurs Alternatifs, Transparents, Ouverts, Neutres et Solidaires) et étant seul à maintenir les services de mes clients, je me suis conçu une infrastructure sécurisée, performante, scalable, automatisée et facile à maintenir." data-next-head=""/><meta property="og:type" content="article" data-next-head=""/><meta property="article:published_time" content="2019-01-01T18:40:00.000Z" data-next-head=""/><meta property="article:modified_time" content="2019-01-01T18:40:00.000Z" data-next-head=""/><meta property="og:image" content="https://johackim.com/covers/infrastructure-hebergeur-web-independant.jpg" data-next-head=""/><link rel="preload" href="/_next/static/media/ce62453a442c7f35-s.p.a9507876.woff2" as="font" type="font/woff2" crossorigin="anonymous" data-next-font="size-adjust"/><link rel="preload" href="/_next/static/chunks/8ed76ae3e03c2690.css" as="style"/><link rel="stylesheet" href="/_next/static/chunks/8ed76ae3e03c2690.css" data-n-g=""/><noscript data-n-css=""></noscript><script src="/_next/static/chunks/97f1dd4e262d3e45.js" defer=""></script><script src="/_next/static/chunks/8f7fdb01d15a8219.js" defer=""></script><script src="/_next/static/chunks/55735a38717165a8.js" defer=""></script><script src="/_next/static/chunks/a249cebd710f48a2.js" defer=""></script><script src="/_next/static/chunks/turbopack-97de175104240c95.js" defer=""></script><script src="/_next/static/chunks/615902924f16b9ba.js" defer=""></script><script src="/_next/static/chunks/35397db3c735b8cf.js" defer=""></script><script src="/_next/static/chunks/c9f672f0cfe9662d.js" defer=""></script><script src="/_next/static/chunks/turbopack-7d6231749b9d5e15.js" defer=""></script><script src="/_next/static/37kNBSZEarMk2zx1j6Bqx/_ssgManifest.js" defer=""></script><script src="/_next/static/37kNBSZEarMk2zx1j6Bqx/_buildManifest.js" defer=""></script><style id="__jsx-1922640940">html{font-family:'Roboto', 'Roboto Fallback'}</style></head><body><div id="__next"><header class="flex shadow-md inset-x-0 h-16 items-center z-30 text-gray-700 bg-white fixed top-0"><div class="container m-auto flex items-center justify-between flex-wrap px-2 sm:px-4 lg:max-w-screen-lg"><a href="/"><div class="flex items-center"><img alt="logo" loading="lazy" width="48" height="48" decoding="async" data-nimg="1" class="rounded-full w-12" style="color:transparent" src="/profile.jpg"/><div class="ml-2"><div class="font-bold leading-none">Johackim</div><div class="text-sm leading-none">Hacker indépendant</div></div></div></a><nav class="grid grid-flow-col gap-4 items-center"><a class="hover:underline hidden md:block" href="/">Accueil</a><a class="hover:underline md:block" href="/articles">Articles</a><a href="/newsletter"><button type="button" class="bg-cyan-700 text-white hover:text-white hover:bg-cyan-800 px-2.5 py-1.5 rounded-md cursor-pointer">S&#x27;abonner</button></a></nav></div></header><main class="lg:max-w-screen-lg m-auto px-4"><div class="bg-cyan-600 h-1 z-30 fixed inset-0" style="width:0%"></div><script type="application/ld+json" id="article-jsonld-article">{"@context":"https://schema.org","@type":"article","headline":"Mon infrastructure en tant qu'hébergeur web indépendant","url":"https://johackim.com/infrastructure-hebergeur-web-independant","author":{"@type":"Person","name":"Johackim"},"datePublished":"2019-01-01T18:40:00.000Z","dateModified":"2019-01-01T18:40:00.000Z","image":"https://johackim.com/covers/infrastructure-hebergeur-web-independant.jpg","description":"En tant que membre des CHATONS (Collectif des Hébergeurs Alternatifs, Transparents, Ouverts, Neutres et Solidaires) et étant seul à maintenir les services de mes clients, je me suis conçu une infrastructure sécurisée, performante, scalable, automatisée et facile à maintenir."}</script><div class="md:border md:border-gray-200 mt-20"><h1 class="h-64 flex flex-col justify-center relative border-b border-gray-200"><span class="absolute inset-0 bg-gray-100 opacity-80 z-10"></span><span class="transform text-center font-bold px-4 text-4xl text-gray-600 break-words z-20">Mon infrastructure en tant qu&#x27;hébergeur web indépendant</span></h1><div class="text-xs my-4 md:px-4 text-gray-700"><span>Mis à jour le </span><span>mardi 1 janvier 2019</span><span> par <a class="underline text-cyan-700" href="/a-propos">johackim</a></span></div><article class="prose break-words prose-a:font-normal prose-a:text-cyan-700 prose-a:break-words marker:text-gray-700 prose-code:font-normal prose-code:break-words prose-inline-code:px-1.5 prose-inline-code:py-0.5 prose-code:whitespace-pre-wrap prose-code:text-xs prose-code:bg-gray-200 prose-code:rounded-md prose-pre:bg-gray-200 prose-pre:text-gray-700 prose-pre:overflow-x-auto max-w-none px-0 py-4 md:p-4 prose-code:before:hidden prose-code:after:hidden prose-mark:bg-gray-300 prose-td:border-gray-300 prose-td:border prose-td:px-4 prose-th:border prose-th:border-gray-300 prose-th:px-4 prose-th:py-2 [&amp;_blockquote_.callout-title]:flex [&amp;_blockquote_.callout-title]:gap-2"><link rel="preload" as="image" href="https://i.imgur.com/e6l8DD5.png"/><link rel="preload" as="image" href="https://i.imgur.com/lO3QlRr.png"/><div class="space-y-4 whitespace-normal *:first:mt-0 *:last:mb-0"><p>Je me suis récemment donné comme projet de devenir hébergeur indépendant chez les <strong>CHATONS</strong> (le <strong>C</strong>ollectif des <strong>H</strong>ébergeurs <strong>A</strong>lternatifs, <strong>T</strong>ransparents, <strong>O</strong>uverts, <strong>N</strong>eutres et <strong>S</strong>olidaires). Étant seul à maintenir les services de mes clients, j’ai dû concevoir une infrastructure <strong>sécurisée</strong>, <strong>performante</strong>, <strong>scalable</strong>, <strong>automatisée</strong> et <strong>facile à maintenir</strong>. Je vais à travers cet article vous décrire les étapes à suivre pour monter ce type d’infrastructure.</p><h2>1. Présentation de l&#x27;infrastructure</h2><p>Dans cette infrastructure, chaque application tourne sous forme d’un ou plusieurs conteneurs répartis sur un ou plusieurs serveurs selon leurs ressources disponibles.</p><p><img src="https://i.imgur.com/e6l8DD5.png" alt="Infrastructure"/></p><p>Les <strong>conteneurs</strong> permettent d’<strong>accélérer et faciliter le déploiement des applications</strong>, ils contiennent toutes les dépendances d’une application et sont indépendants vis-à-vis de l’infrastructure hôte. Additionné à un orchestrateur, par exemple <strong>Docker Swarm</strong>, on dispose d’un système qui exécute, coordonne et <strong>gère entièrement le cycle de vie de nos applications</strong>.</p><p>Aujourd’hui je démarre mon infrastructure avec trois petits serveurs, demain elle pourra <strong>évoluer facilement</strong> suivant l’augmentation des demandes clients.</p><p>Plutôt que de gérer mon infrastructure sous forme de <strong>tâches manuelles et répétitives</strong>, une grande partie est gérée à l’aide de <strong>fichiers de définition</strong> que je versionne. Dans mon cas, il s’agit principalement de fichiers <strong>YAML</strong>.</p><p>Si jamais tous mes serveurs venaient à être stoppés ou supprimés inintentionnellement, je peux à priori tout restaurer en moins d’une heure du moment que je dispose des <strong>backups</strong>.</p><p>Une fois l’infrastructure mise en place, il est possible de démarrer une application en seulement une ligne de commande, par exemple :</p><ul>
<li>Un <strong>tchat</strong> (ex : rocket.chat)</li>
<li>Un <strong>blog</strong> (ex : WordPress, Joomla, Ghost)</li>
<li>Un <strong>site e-commerce</strong> (ex : PrestaShop)</li>
<li>Un <strong>espace de stockage</strong> (ex : ownCloud, Nextcloud)</li>
<li>Un <strong>système de facturation</strong> (ex : Invoice Ninja)</li>
<li>Un <strong>système de monitoring et d’alerting</strong> (ex : Grafana + Prometheus + Alertmanager)</li>
</ul><p>Le tout avec un <strong>nom de domaine</strong> et un <strong>certicat SSL</strong> associé automatiquement.</p><h2>2. Déploiement des serveurs</h2><p>Aujourd’hui je dispose de <strong>trois serveurs Ubuntu Xenial chez Scaleway</strong>. <strong>Un serveur <a class="" target="_blank" href="https://scaleway.com/pricing/#anchor_baremetal">C2S</a></strong> en tant que master et <strong>deux serveurs <a class="" target="_blank" href="https://scaleway.com/pricing/#anchor_starter">START1-S</a></strong> en tant que workers. Si vous le souhaitez, vous pouvez commencer avec un seul serveur dans un premier temps. De même, il est tout à fait envisageable de créer ce type d’infrastructure sur votre propre matériel physique si vous en avez les moyens.</p><p>Première étape on installe <strong>docker</strong> sur chaque serveur :</p><div class="relative group"><button type="button" class="invisible group-hover:visible absolute top-0 right-0 rounded-md text-xs bg-gray-300 m-3 p-1.5 cursor-pointer leading-none">Copier</button><pre><code class="language-bash">apt-get update; apt-get upgrade; apt-get dist-upgrade;
apt-get install -y apt-transport-https
curl -fsSL https://download.docker.com/linux/ubuntu/gpg | sudo apt-key add -
sudo add-apt-repository &quot;deb [arch=amd64] https://download.docker.com/linux/ubuntu $(lsb_release -cs) stable&quot;
sudo apt-get update; sudo apt-get install -y docker-ce
</code></pre></div><p>Ensuite, on initialise Docker Swarm sur le serveur master :</p><div class="relative group"><button type="button" class="invisible group-hover:visible absolute top-0 right-0 rounded-md text-xs bg-gray-300 m-3 p-1.5 cursor-pointer leading-none">Copier</button><pre><code class="language-bash">docker swarm init --advertise-addr eth0:2377
</code></pre></div><p>Puis, on joint les serveurs workers au serveur master :</p><div class="relative group"><button type="button" class="invisible group-hover:visible absolute top-0 right-0 rounded-md text-xs bg-gray-300 m-3 p-1.5 cursor-pointer leading-none">Copier</button><pre><code class="language-bash">docker swarm join --token &lt;token&gt; &lt;mondomaine.priv.cloud.scaleway.com&gt;:2377
</code></pre></div><p><strong>Note</strong>: Scaleway change les adresses IP privées lors du redémarrage des serveurs. Pour cette raison je dois faire communiquer les serveurs entre eux par leurs domaines privés qui eux restent fixes. Si vous ne passez pas par Scaleway vous pouvez utiliser des adresses IP directement.</p><p>Pour la configuration du <strong>swap</strong>, voilà les commandes que j&#x27;exécute :</p><div class="relative group"><button type="button" class="invisible group-hover:visible absolute top-0 right-0 rounded-md text-xs bg-gray-300 m-3 p-1.5 cursor-pointer leading-none">Copier</button><pre><code class="language-bash">fallocate -l 2G /swap
mkswap /swap
echo &quot;/swap  none  swap  sw 0  0&quot; &gt;&gt; /etc/fstab
swapon -a
echo &quot;vm.swappiness = 10&quot; &gt;&gt; /etc/sysctl.d/99-swap.conf
sed -i -e &#x27;s/GRUB_CMDLINE_LINUX=&quot;&quot;/GRUB_CMDLINE_LINUX=&quot;cgroup_enable=memory swapaccount=1&quot;/g&#x27; /etc/default/grub
update-grub
</code></pre></div><h2>3. Persistence des données</h2><p>Une application <strong>stateful</strong>, contrairement à une application stateless, a besoin de persister certaines données comme une base de données (des fichiers de configurations ou de simples fichiers images par exemple). On utilise pour ça les <strong>volumes docker</strong>. De plus, avec <strong>Docker Swarm</strong>, les containers sont volatiles et ne restent pas toujours reliés à un unique serveur. Il faut donc utiliser un <a class="" target="_blank" href="https://docs.docker.com/engine/extend/legacy_plugins/#volume-plugins">volume driver</a>.</p><h3>Un espace de stockage flexible</h3><p>Afin d’éviter d’éparpiller les données et étendre facilement la taille de notre espace de stockage, j’ai créé une <strong>partition LVM</strong> (Logical Volume Manager) qui combine plusieurs volumes de données. Au fur et à mesure que l’infrastructure grandit, il est possible d’ajouter nos volumes de données à cette partition.</p><p>Avec Scaleway, il est très simple d’ajouter et de relier des volumes de données à un serveur. Une fois nos volumes reliés, nous pouvons les combiner ensemble pour former <strong>un seul point de montage</strong>.</p><p>L’installation se fait sur notre serveur master :</p><div class="relative group"><button type="button" class="invisible group-hover:visible absolute top-0 right-0 rounded-md text-xs bg-gray-300 m-3 p-1.5 cursor-pointer leading-none">Copier</button><pre><code class="language-bash">apt-get install -y lvm2
systemctl start lvm2-lvmetad.socket
pvcreate /dev/{nbd1,nbd2}
vgcreate lvm /dev/nbd1 /dev/nbd2
lvcreate -l 100%FREE -n storage lvm
mkfs -t ext4 /dev/lvm/storage
echo &quot;/dev/mapper/lvm-storage /mnt ext4 rw,relatime 0 0&quot; &gt;&gt; /etc/fstab
mount -a
sed -i -e &#x27;s/use_lvmetad = 1/use_lvmetad = 0/g&#x27; /etc/lvm/lvm.conf
</code></pre></div><p>À l’avenir, si vous souhaitez <strong>agrandir votre espace de stockage</strong> via d’autres volumes, il suffit simplement d’exécuter les commandes suivantes :</p><div class="relative group"><button type="button" class="invisible group-hover:visible absolute top-0 right-0 rounded-md text-xs bg-gray-300 m-3 p-1.5 cursor-pointer leading-none">Copier</button><pre><code class="language-bash">umount /mnt
vgextend lvm /dev/nbd3
lvextend -l +100%Free /dev/lvm/storage
resize2fs /dev/lvm/storage
mount -a
</code></pre></div><h3>Volume driver</h3><p>Le <a class="" target="_blank" href="https://docs.docker.com/engine/extend/legacy_plugins/#volume-plugins">volume driver</a> que j’ai choisi s’appelle docker-volume-netshare. Chaque application persistera ses données sur un serveur NFS.</p><p>On installe notre <strong>serveur NFS</strong> sur notre master :</p><div class="relative group"><button type="button" class="invisible group-hover:visible absolute top-0 right-0 rounded-md text-xs bg-gray-300 m-3 p-1.5 cursor-pointer leading-none">Copier</button><pre><code class="language-bash">sudo apt-get install -y nfs-kernel-server
sudo mkdir /mnt/data
</code></pre></div><p>Puis on autorise tous les serveurs à s’y connecter :</p><div class="relative group"><button type="button" class="invisible group-hover:visible absolute top-0 right-0 rounded-md text-xs bg-gray-300 m-3 p-1.5 cursor-pointer leading-none">Copier</button><pre><code class="language-bash"># /etc/exports
/mnt/data 127.0.0.1(rw,sync,no_subtree_check,no_root_squash) worker-01.priv.cloud.scaleway.com(rw,sync,no_subtree_check,no_root_squash) worker-02(rw,sync,no_subtree_check,no_root_squash)    
</code></pre></div><p>On redémarre notre serveur afin d’appliquer notre configuration :</p><div class="relative group"><button type="button" class="invisible group-hover:visible absolute top-0 right-0 rounded-md text-xs bg-gray-300 m-3 p-1.5 cursor-pointer leading-none">Copier</button><pre><code class="language-bash">sudo systemctl restart nfs-kernel-server
</code></pre></div><p>Puis on installe sur tous les serveurs le package nfs-common et notre <strong>volume</strong> driver docker-volume-netshare :</p><div class="relative group"><button type="button" class="invisible group-hover:visible absolute top-0 right-0 rounded-md text-xs bg-gray-300 m-3 p-1.5 cursor-pointer leading-none">Copier</button><pre><code class="language-bash">sudo apt-get install -y nfs-common
</code></pre></div><div class="relative group"><button type="button" class="invisible group-hover:visible absolute top-0 right-0 rounded-md text-xs bg-gray-300 m-3 p-1.5 cursor-pointer leading-none">Copier</button><pre><code class="language-bash">sudo wget -O /usr/bin/docker-volume-netshare https://github.com/ContainX/docker-volume-netshare/releases/download/v0.35/docker-volume-netshare_0.35_linux_amd64-bin
sudo chmod +x /usr/bin/docker-volume-netshare
</code></pre></div><p>On crée <strong>un service</strong> docker-volume-netshare qui sera lancé à chaque démarrage serveur :</p><div class="relative group"><button type="button" class="invisible group-hover:visible absolute top-0 right-0 rounded-md text-xs bg-gray-300 m-3 p-1.5 cursor-pointer leading-none">Copier</button><pre><code class="language-service"># /etc/systemd/system/docker-volume-netshare.service
[Unit]
Description=Docker NFS, AWS EFS &amp; Samba/CIFS Volume Plugin
Documentation=https://github.com/gondor/docker-volume-netshare
Wants=network-online.target
After=network-online.target
Before=docker.service

[Service]
ExecStart=/usr/bin/docker-volume-netshare nfs
StandardOutput=syslog

[Install]
WantedBy=multi-user.target
</code></pre></div><div class="relative group"><button type="button" class="invisible group-hover:visible absolute top-0 right-0 rounded-md text-xs bg-gray-300 m-3 p-1.5 cursor-pointer leading-none">Copier</button><pre><code class="language-bash">systemctl enable docker-volume-netshare.service
systemctl start docker-volume-netshare.service
</code></pre></div><p>Pour vérifier si tout fonctionne correctement, vous pouvez créer un volume « test » :</p><div class="relative group"><button type="button" class="invisible group-hover:visible absolute top-0 right-0 rounded-md text-xs bg-gray-300 m-3 p-1.5 cursor-pointer leading-none">Copier</button><pre><code class="language-bash">docker volume create --driver nfs --name=test --opt share=127.0.0.1:/mnt/data --opt create=true
</code></pre></div><p>Puis créer un fichier « test » depuis un container :</p><div class="relative group"><button type="button" class="invisible group-hover:visible absolute top-0 right-0 rounded-md text-xs bg-gray-300 m-3 p-1.5 cursor-pointer leading-none">Copier</button><pre><code class="language-bash">docker run --rm -v test:/mount alpine touch /mount/test
</code></pre></div><p>Ce fichier devrait apparaître dans le répertoire /mnt/data de votre serveur master.</p><h2>4. Sauvegardes automatisées</h2><p><strong>Objectif</strong> : Créer un système de sauvegarde journalier de tous les <strong>volumes</strong>.</p><p>Pour sauvegarder nos volumes il nous suffit de sauvegarder notre dossier /mnt/data avec notre outil de backup préféré (borg, restic, duplicity, etc.).</p><p>Personnellement j’utilise <strong>restic</strong> :</p><div class="relative group"><button type="button" class="invisible group-hover:visible absolute top-0 right-0 rounded-md text-xs bg-gray-300 m-3 p-1.5 cursor-pointer leading-none">Copier</button><pre><code class="language-bash">wget https://github.com/restic/restic/releases/download/v0.9.3/restic_0.9.3_linux_amd64.bz2
bzip2 -d restic_0.9.3_linux_amd64.bz2
mv restic_0.9.3_linux_amd64 /usr/local/bin/restic
chmod +x /usr/local/bin/restic
</code></pre></div><p>Le processus de sauvegarde est très simple avec restic :</p><div class="relative group"><button type="button" class="invisible group-hover:visible absolute top-0 right-0 rounded-md text-xs bg-gray-300 m-3 p-1.5 cursor-pointer leading-none">Copier</button><pre><code class="language-bash">restic -r &lt;repository&gt; init
restic -r &lt;repository&gt; backup /mnt/data
</code></pre></div><p>Il existe plusieurs types de <strong>repository</strong> : local, S3, sftp, rclone, etc. Personnellement j’utilise <strong>S3</strong>, car Scaleway propose un <strong>Object Storage</strong> comme AWS, du coup j’en profite.</p><p>On automatise ensuite la sauvegarde avec une <strong>tâche cron</strong> :</p><div class="relative group"><button type="button" class="invisible group-hover:visible absolute top-0 right-0 rounded-md text-xs bg-gray-300 m-3 p-1.5 cursor-pointer leading-none">Copier</button><pre><code class="language-bash"># crontab -e
0 0 * * * /usr/local/bin/restic -r &lt;repository&gt; backup /mnt/data
</code></pre></div><h3>Restauration</h3><p>Dans le cas où vous souhaitez récupérer une sauvegarde précédente :</p><div class="relative group"><button type="button" class="invisible group-hover:visible absolute top-0 right-0 rounded-md text-xs bg-gray-300 m-3 p-1.5 cursor-pointer leading-none">Copier</button><pre><code class="language-bash">restic -r &lt;repository&gt; snapshots
restic -r &lt;repository&gt; restore &lt;snapshotID&gt; -t restore
</code></pre></div><h2>5. Reverse-proxy et Let’s Encrypt</h2><p><strong>Objectif</strong>: Configurer un <strong>reverse proxy</strong> pour accéder à nos applications via un <strong>unique point d’entrée</strong>.</p><p>Personnellement, j’utilise <strong>Traefik</strong>, qui est compatible avec <strong>Docker Swarm</strong>.</p><p>On crée <strong>un network</strong> que l’on nomme par exemple <strong>traefik-net,</strong> il sera utilisé pour relier de manière automatique chaque application à <strong>Traefik</strong> à l’aide des <strong>labels</strong>.</p><div class="relative group"><button type="button" class="invisible group-hover:visible absolute top-0 right-0 rounded-md text-xs bg-gray-300 m-3 p-1.5 cursor-pointer leading-none">Copier</button><pre><code class="language-bash">docker network create --driver=overlay traefik-net
</code></pre></div><p>Puis on déploie <strong>Traefik</strong> uniquement sur notre serveur master :</p><div class="relative group"><button type="button" class="invisible group-hover:visible absolute top-0 right-0 rounded-md text-xs bg-gray-300 m-3 p-1.5 cursor-pointer leading-none">Copier</button><pre><code class="language-yml"># traefik.yml

version: &quot;3.3&quot;
services:
  traefik:
    image: traefik
    command: --docker \
      --docker.swarmMode \
      --docker.watch
    ports:
      - &quot;80:80&quot;
    volumes:
      - /var/run/docker.sock:/var/run/docker.sock
    deploy:
      placement:
        constraints: [node.role==manager]

networks:
  default:
    external:
      name: traefik-net
</code></pre></div><div class="relative group"><button type="button" class="invisible group-hover:visible absolute top-0 right-0 rounded-md text-xs bg-gray-300 m-3 p-1.5 cursor-pointer leading-none">Copier</button><pre><code class="language-bash">docker stack deploy -c traefik.yml traefik
</code></pre></div><p>Enfin, pour relier une application à notre <strong>reverse proxy</strong>, on peut créer un <strong>service</strong> docker avec des <strong>labels</strong> qui indiqueront à <strong>Traefik</strong> de diriger le traffic HTTP du domaine <a class="" target="_blank" href="https://johackim.com">johackim.com</a> sur le(s) bon(s) container(s) :</p><div class="relative group"><button type="button" class="invisible group-hover:visible absolute top-0 right-0 rounded-md text-xs bg-gray-300 m-3 p-1.5 cursor-pointer leading-none">Copier</button><pre><code class="language-bash">docker service create --name blog --network traefik-net -l traefik.port=2368 -l traefik.frontend.rule=Host:johackim.com -l traefik.enable=true ghost
</code></pre></div><h3>Let’s Encrypt</h3><p>Pour <strong>automatiser la création de certificats SSL</strong> des services exposés à l’extérieur de mon cluster, j’ai configuré <strong>Traefik</strong> avec ce fichier de configuration :</p><div class="relative group"><button type="button" class="invisible group-hover:visible absolute top-0 right-0 rounded-md text-xs bg-gray-300 m-3 p-1.5 cursor-pointer leading-none">Copier</button><pre><code class="language-toml"># traefik.toml

debug = true
logLevel = &quot;DEBUG&quot;
defaultEntryPoints = [&quot;https&quot;,&quot;http&quot;]

[entryPoints]
  [entryPoints.http]
  address = &quot;:80&quot;
    [entryPoints.http.redirect]
    entryPoint = &quot;https&quot;
  [entryPoints.https]
  address = &quot;:443&quot;
    [entryPoints.https.tls]

[acme]
email = &quot;contact@example.com&quot;
storage = &quot;acme.json&quot;
acmeLogging = true
entryPoint = &quot;https&quot;
onHostRule = true

[acme.httpChallenge]
  entryPoint = &quot;http&quot;
</code></pre></div><h2>6. Infrastructure as Code</h2><p>Toutes les applications sont définies sous forme de code. <strong>Un fichier YAML</strong> représente tout ce que contient une application (<strong>services, volumes, networks</strong>).</p><p>Voici comme exemple le fichier ghost.yml que j’utilise pour le déploiement de mon blog :</p><div class="relative group"><button type="button" class="invisible group-hover:visible absolute top-0 right-0 rounded-md text-xs bg-gray-300 m-3 p-1.5 cursor-pointer leading-none">Copier</button><pre><code class="language-yml"># ghost.yml

version: &#x27;3&#x27;

services:
  web:
    image: ghost:2.4.0
    volumes:
      - ghost:/var/lib/ghost/content:nocopy
    environment:
      url: ${SCHEME:-http}://${DOMAIN:?err}
    deploy:
      labels:
        traefik.port: 2368
        traefik.frontend.rule: Host:${DOMAIN:?err}
        traefik.enable: &quot;true&quot;

volumes:
  ghost:
    driver: nfs
    driver_opts:
      share: master.priv.cloud.scaleway.com:/mnt/data
      create: &quot;true&quot;

networks:
  default:
    external:
      name: traefik-net
</code></pre></div><p>En une seule commande, je peux déployer un blog ghost sous le nom de domaine que je souhaite, et avec un certificat ssl automatiquement attribué :</p><div class="relative group"><button type="button" class="invisible group-hover:visible absolute top-0 right-0 rounded-md text-xs bg-gray-300 m-3 p-1.5 cursor-pointer leading-none">Copier</button><pre><code class="language-bash">SCHEME=https DOMAIN=johackim.com docker stack deploy -c ghost.yml blog
</code></pre></div><p>J’ai créé d’autres stacks que <strong>Ghost</strong>, je vous invite à vous rendre sur <a class="" target="_blank" href="https://github.com/ethibox/awesome-stacks/">ce repository</a> si vous désirez en voir d’autres.</p><h2>7. Monitoring, alerting et logging</h2><p>Pour <strong>monitorer</strong> tous mes serveurs, pour être <strong>alerté</strong> à chaque fois qu’une application ne renvoie pas un <strong>code 200</strong> ou qu’un <strong>CPU, RAM, Disque</strong> dépasse les 95% d’utilisation. Je me suis créé une <a class="" target="_blank" href="https://raw.githubusercontent.com/ethibox/awesome-stacks/ee0f0474bb8237b32f1a0a84a12275ed855362d4/monitoring.yml">stack avec grafana, prometheus et alertmanager</a>.</p><p><img src="https://i.imgur.com/lO3QlRr.png" alt="Dashboard Grafana"/></p><p>Et d’une commande, je peux tout installer :</p><div class="relative group"><button type="button" class="invisible group-hover:visible absolute top-0 right-0 rounded-md text-xs bg-gray-300 m-3 p-1.5 cursor-pointer leading-none">Copier</button><pre><code class="language-bash">DOMAIN_GRAFANA=grafana.mondomaine.fr DOMAIN_PROMETHEUS=prometheus.mondomaine.fr docker stack deploy -c monitoring.yml monitoring
</code></pre></div><p><a class="" target="_blank" href="https://github.com/ethibox/awesome-stacks/blob/91c336d4c42b3b2dd056a15b65c1d996ce08c236/elastic.yml">La stack elastic</a> quant à elle, va me servir à <strong>logger tout le traffic HTTP entrant</strong> sur <strong>Traefik</strong> et <strong>collecter les syslog</strong> de chaque serveur.</p><div class="relative group"><button type="button" class="invisible group-hover:visible absolute top-0 right-0 rounded-md text-xs bg-gray-300 m-3 p-1.5 cursor-pointer leading-none">Copier</button><pre><code class="language-bash">DOMAIN=kibana.mondomaine.fr docker stack deploy -c elastic.yml elastic
</code></pre></div><h2>8. Sécurité</h2><p>En termes de sécurité, je provisionne tous mes serveurs avec un <a class="" target="_blank" href="https://github.com/johackim/ansible-personal">playbook</a> Ansible. Concrètement, je configure tous mes serveurs avec un <strong>IPS</strong> (fail2ban), un <strong>firewall</strong> (iptables) et des <strong>règles de system hardening</strong>.</p><div class="relative group"><button type="button" class="invisible group-hover:visible absolute top-0 right-0 rounded-md text-xs bg-gray-300 m-3 p-1.5 cursor-pointer leading-none">Copier</button><pre><code class="language-bash">ansible-playbook playbook.yml -u root -i &lt;PUBLIC_IP&gt;,
</code></pre></div><p>Je crée aussi des règles de sécurité avec les <strong>security group</strong> de Scaleway, puis des <strong>headers HTTP sécurisés</strong> pour chaque application :</p><div class="relative group"><button type="button" class="invisible group-hover:visible absolute top-0 right-0 rounded-md text-xs bg-gray-300 m-3 p-1.5 cursor-pointer leading-none">Copier</button><pre><code class="language-bash">docker service update &lt;name_app&gt; --label-add traefik.frontend.headers.customResponseHeaders=&quot;X-XSS-Protection: 1; mode=block&quot;
</code></pre></div><h2>Conclusion</h2><p>De manière subjective, c’est la solution idéale pour moi, après avoir testé plusieurs solutions (<strong>Kubernetes, Helm, Ark, Ceph, Rook, Minio et Rexray</strong>) c’est celle qui dans mon cas est la plus <strong>accessible, maintenable, scalable</strong> et <strong>performante</strong>.</p><p>Sa scalabilité me permet d’<strong>éviter d’investir trop d’argent</strong> dans de très gros serveurs et d’<strong>évoluer proportionnellement</strong> à la demande des clients.</p><p>Je pense avoir créé une bonne base, il me reste sûrement encore beaucoup de choses à améliorer, dont par exemple :</p><ul>
<li>Ajouter des <strong><a class="" target="_blank" href="https://docs.docker.com/compose/compose-file/#healthcheck">healthcheck</a></strong> et <strong><a class="" target="_blank" href="https://docs.docker.com/config/containers/resource_constraints/">limite de ressource</a></strong> Docker</li>
<li>Me créer un <strong>Siem</strong> avec la stack <strong>Elastic</strong> et <strong>Surricata</strong></li>
<li>Générer de manière aléatoire et automatique les mots de passes dans des <strong>docker secrets</strong>.</li>
<li><strong>Auto-héberger</strong> toute l’infrastucture chez moi sur mon propre matériel, pour ne plus dépendre de <strong>Scaleway</strong>.</li>
<li>Un <strong>stockage distribué</strong></li>
</ul><p>N’hésitez pas à me dire dans les commentaires si vous avez des suggestions d’améliorations !</p><hr/><p>Références :</p><ul>
<li>
<a class="" href="/hebergement-web">Hébergement web</a>

</li>
</ul></div></article><div class="md:px-4"><hr class="border-gray-200 mb-4 mt-8"/><div id="commento"></div></div></div></main><footer class="container m-auto px-4 py-8 flex items-center justify-between flex-wrap lg:max-w-screen-lg text-gray-700"><div><span class="inline-block transform rotate-180">©</span><span class="ml-2">2017-2026</span></div><nav class="grid grid-flow-col gap-2 items-center"><a href="https://x.com/_johackim" aria-label="X" target="_blank" rel="noreferrer"><svg class="h-5 w-5 fill-current hover:text-black" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path d="M18.901 1.153h3.68l-8.04 9.19L24 22.846h-7.406l-5.8-7.584-6.638 7.584H.474l8.6-9.83L0 1.154h7.594l5.243 6.932ZM17.61 20.644h2.039L6.486 3.24H4.298Z"></path></svg></a><a href="https://t.me/johackim" aria-label="Telegram" target="_blank" rel="noreferrer"><svg class="h-5 w-5 fill-current hover:text-black" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path d="M11.944 0A12 12 0 0 0 0 12a12 12 0 0 0 12 12 12 12 0 0 0 12-12A12 12 0 0 0 12 0a12 12 0 0 0-.056 0zm4.962 7.224c.1-.002.321.023.465.14a.506.506 0 0 1 .171.325c.016.093.036.306.02.472-.18 1.898-.962 6.502-1.36 8.627-.168.9-.499 1.201-.82 1.23-.696.065-1.225-.46-1.9-.902-1.056-.693-1.653-1.124-2.678-1.8-1.185-.78-.417-1.21.258-1.91.177-.184 3.247-2.977 3.307-3.23.007-.032.014-.15-.056-.212s-.174-.041-.249-.024c-.106.024-1.793 1.14-5.061 3.345-.48.33-.913.49-1.302.48-.428-.008-1.252-.241-1.865-.44-.752-.245-1.349-.374-1.297-.789.027-.216.325-.437.893-.663 3.498-1.524 5.83-2.529 6.998-3.014 3.332-1.386 4.025-1.627 4.476-1.635z"></path></svg></a><a href="https://mastodon.ethibox.fr/@johackim" aria-label="Mastodon" target="_blank" rel="noreferrer"><svg class="h-5 w-5 fill-current hover:text-black" viewBox="0 0 448 512" xmlns="http://www.w3.org/2000/svg"><path d="M433 179.11c0-97.2-63.71-125.7-63.71-125.7-62.52-28.7-228.56-28.4-290.48 0 0 0-63.72 28.5-63.72 125.7 0 115.7-6.6 259.4 105.63 289.1 40.51 10.7 75.32 13 103.33 11.4 50.81-2.8 79.32-18.1 79.32-18.1l-1.7-36.9s-36.31 11.4-77.12 10.1c-40.41-1.4-83-4.4-89.63-54a102.54 102.54 0 0 1-.9-13.9c85.63 20.9 158.65 9.1 178.75 6.7 56.12-6.7 105-41.3 111.23-72.9 9.8-49.8 9-121.5 9-121.5zm-75.12 125.2h-46.63v-114.2c0-49.7-64-51.6-64 6.9v62.5h-46.33V197c0-58.5-64-56.6-64-6.9v114.2H90.19c0-122.1-5.2-147.9 18.41-175 25.9-28.9 79.82-30.8 103.83 6.1l11.6 19.5 11.6-19.5c24.11-37.1 78.12-34.8 103.83-6.1 23.71 27.3 18.4 53 18.4 175z"></path></svg></a><a href="https://github.com/johackim" aria-label="Github" target="_blank" rel="noreferrer"><svg class="h-5 w-5 fill-current hover:text-black" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path d="M12 .297c-6.63 0-12 5.373-12 12 0 5.303 3.438 9.8 8.205 11.385.6.113.82-.258.82-.577 0-.285-.01-1.04-.015-2.04-3.338.724-4.042-1.61-4.042-1.61C4.422 18.07 3.633 17.7 3.633 17.7c-1.087-.744.084-.729.084-.729 1.205.084 1.838 1.236 1.838 1.236 1.07 1.835 2.809 1.305 3.495.998.108-.776.417-1.305.76-1.605-2.665-.3-5.466-1.332-5.466-5.93 0-1.31.465-2.38 1.235-3.22-.135-.303-.54-1.523.105-3.176 0 0 1.005-.322 3.3 1.23.96-.267 1.98-.399 3-.405 1.02.006 2.04.138 3 .405 2.28-1.552 3.285-1.23 3.285-1.23.645 1.653.24 2.873.12 3.176.765.84 1.23 1.91 1.23 3.22 0 4.61-2.805 5.625-5.475 5.92.42.36.81 1.096.81 2.22 0 1.606-.015 2.896-.015 3.286 0 .315.21.69.825.57C20.565 22.092 24 17.592 24 12.297c0-6.627-5.373-12-12-12"></path></svg></a><a href="https://linkedin.com/in/johackim" aria-label="LinkedIn" target="_blank" rel="noreferrer"><svg class="h-5 w-5 fill-current hover:text-black" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path d="M20.447 20.452h-3.554v-5.569c0-1.328-.027-3.037-1.852-3.037-1.853 0-2.136 1.445-2.136 2.939v5.667H9.351V9h3.414v1.561h.046c.477-.9 1.637-1.85 3.37-1.85 3.601 0 4.267 2.37 4.267 5.455v6.286zM5.337 7.433c-1.144 0-2.063-.926-2.063-2.065 0-1.138.92-2.063 2.063-2.063 1.14 0 2.064.925 2.064 2.063 0 1.139-.925 2.065-2.064 2.065zm1.782 13.019H3.555V9h3.564v11.452zM22.225 0H1.771C.792 0 0 .774 0 1.729v20.542C0 23.227.792 24 1.771 24h20.451C23.2 24 24 23.227 24 22.271V1.729C24 .774 23.2 0 22.222 0h.003z"></path></svg></a><a href="mailto:contact+blog@johackim.com" aria-label="Mail" target="_blank" rel="noreferrer"><svg class="h-5 w-5 fill-current hover:text-black" viewBox="0 0 512 512" xmlns="http://www.w3.org/2000/svg"><path d="M502.3 190.8c3.9-3.1 9.7-.2 9.7 4.7V400c0 26.5-21.5 48-48 48H48c-26.5 0-48-21.5-48-48V195.6c0-5 5.7-7.8 9.7-4.7 22.4 17.4 52.1 39.5 154.1 113.6 21.1 15.4 56.7 47.8 92.2 47.6 35.7.3 72-32.8 92.3-47.6 102-74.1 131.6-96.3 154-113.7zM256 320c23.2.4 56.6-29.2 73.4-41.4 132.7-96.3 142.8-104.7 173.4-128.7 5.8-4.5 9.2-11.5 9.2-18.9v-19c0-26.5-21.5-48-48-48H48C21.5 64 0 85.5 0 112v19c0 7.4 3.4 14.3 9.2 18.9 30.6 23.9 40.7 32.4 173.4 128.7 16.8 12.2 50.2 41.8 73.4 41.4z"></path></svg></a><a href="/rss.xml" aria-label="RSS" target="_blank" rel="noreferrer"><svg class="h-5 w-5 fill-current hover:text-black" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><circle cx="6.18" cy="17.82" r="2.18"></circle><path d="M4 4.44v2.83c7.03 0 12.73 5.7 12.73 12.73h2.83c0-8.59-6.97-15.56-15.56-15.56zm0 5.66v2.83c3.9 0 7.07 3.17 7.07 7.07h2.83c0-5.47-4.43-9.9-9.9-9.9z"></path></svg></a></nav></footer></div><script id="__NEXT_DATA__" type="application/json">{"props":{"pageProps":{"source":"\u003clink rel=\"preload\" as=\"image\" href=\"https://i.imgur.com/e6l8DD5.png\"/\u003e\u003clink rel=\"preload\" as=\"image\" href=\"https://i.imgur.com/lO3QlRr.png\"/\u003e\u003cdiv class=\"space-y-4 whitespace-normal *:first:mt-0 *:last:mb-0\"\u003e\u003cp\u003eJe me suis récemment donné comme projet de devenir hébergeur indépendant chez les \u003cstrong\u003eCHATONS\u003c/strong\u003e (le \u003cstrong\u003eC\u003c/strong\u003eollectif des \u003cstrong\u003eH\u003c/strong\u003eébergeurs \u003cstrong\u003eA\u003c/strong\u003elternatifs, \u003cstrong\u003eT\u003c/strong\u003eransparents, \u003cstrong\u003eO\u003c/strong\u003euverts, \u003cstrong\u003eN\u003c/strong\u003eeutres et \u003cstrong\u003eS\u003c/strong\u003eolidaires). Étant seul à maintenir les services de mes clients, j’ai dû concevoir une infrastructure \u003cstrong\u003esécurisée\u003c/strong\u003e, \u003cstrong\u003eperformante\u003c/strong\u003e, \u003cstrong\u003escalable\u003c/strong\u003e, \u003cstrong\u003eautomatisée\u003c/strong\u003e et \u003cstrong\u003efacile à maintenir\u003c/strong\u003e. Je vais à travers cet article vous décrire les étapes à suivre pour monter ce type d’infrastructure.\u003c/p\u003e\u003ch2\u003e1. Présentation de l\u0026#x27;infrastructure\u003c/h2\u003e\u003cp\u003eDans cette infrastructure, chaque application tourne sous forme d’un ou plusieurs conteneurs répartis sur un ou plusieurs serveurs selon leurs ressources disponibles.\u003c/p\u003e\u003cp\u003e\u003cimg src=\"https://i.imgur.com/e6l8DD5.png\" alt=\"Infrastructure\"/\u003e\u003c/p\u003e\u003cp\u003eLes \u003cstrong\u003econteneurs\u003c/strong\u003e permettent d’\u003cstrong\u003eaccélérer et faciliter le déploiement des applications\u003c/strong\u003e, ils contiennent toutes les dépendances d’une application et sont indépendants vis-à-vis de l’infrastructure hôte. Additionné à un orchestrateur, par exemple \u003cstrong\u003eDocker Swarm\u003c/strong\u003e, on dispose d’un système qui exécute, coordonne et \u003cstrong\u003egère entièrement le cycle de vie de nos applications\u003c/strong\u003e.\u003c/p\u003e\u003cp\u003eAujourd’hui je démarre mon infrastructure avec trois petits serveurs, demain elle pourra \u003cstrong\u003eévoluer facilement\u003c/strong\u003e suivant l’augmentation des demandes clients.\u003c/p\u003e\u003cp\u003ePlutôt que de gérer mon infrastructure sous forme de \u003cstrong\u003etâches manuelles et répétitives\u003c/strong\u003e, une grande partie est gérée à l’aide de \u003cstrong\u003efichiers de définition\u003c/strong\u003e que je versionne. Dans mon cas, il s’agit principalement de fichiers \u003cstrong\u003eYAML\u003c/strong\u003e.\u003c/p\u003e\u003cp\u003eSi jamais tous mes serveurs venaient à être stoppés ou supprimés inintentionnellement, je peux à priori tout restaurer en moins d’une heure du moment que je dispose des \u003cstrong\u003ebackups\u003c/strong\u003e.\u003c/p\u003e\u003cp\u003eUne fois l’infrastructure mise en place, il est possible de démarrer une application en seulement une ligne de commande, par exemple :\u003c/p\u003e\u003cul\u003e\n\u003cli\u003eUn \u003cstrong\u003etchat\u003c/strong\u003e (ex : rocket.chat)\u003c/li\u003e\n\u003cli\u003eUn \u003cstrong\u003eblog\u003c/strong\u003e (ex : WordPress, Joomla, Ghost)\u003c/li\u003e\n\u003cli\u003eUn \u003cstrong\u003esite e-commerce\u003c/strong\u003e (ex : PrestaShop)\u003c/li\u003e\n\u003cli\u003eUn \u003cstrong\u003eespace de stockage\u003c/strong\u003e (ex : ownCloud, Nextcloud)\u003c/li\u003e\n\u003cli\u003eUn \u003cstrong\u003esystème de facturation\u003c/strong\u003e (ex : Invoice Ninja)\u003c/li\u003e\n\u003cli\u003eUn \u003cstrong\u003esystème de monitoring et d’alerting\u003c/strong\u003e (ex : Grafana + Prometheus + Alertmanager)\u003c/li\u003e\n\u003c/ul\u003e\u003cp\u003eLe tout avec un \u003cstrong\u003enom de domaine\u003c/strong\u003e et un \u003cstrong\u003ecerticat SSL\u003c/strong\u003e associé automatiquement.\u003c/p\u003e\u003ch2\u003e2. Déploiement des serveurs\u003c/h2\u003e\u003cp\u003eAujourd’hui je dispose de \u003cstrong\u003etrois serveurs Ubuntu Xenial chez Scaleway\u003c/strong\u003e. \u003cstrong\u003eUn serveur \u003ca class=\"\" target=\"_blank\" href=\"https://scaleway.com/pricing/#anchor_baremetal\"\u003eC2S\u003c/a\u003e\u003c/strong\u003e en tant que master et \u003cstrong\u003edeux serveurs \u003ca class=\"\" target=\"_blank\" href=\"https://scaleway.com/pricing/#anchor_starter\"\u003eSTART1-S\u003c/a\u003e\u003c/strong\u003e en tant que workers. Si vous le souhaitez, vous pouvez commencer avec un seul serveur dans un premier temps. De même, il est tout à fait envisageable de créer ce type d’infrastructure sur votre propre matériel physique si vous en avez les moyens.\u003c/p\u003e\u003cp\u003ePremière étape on installe \u003cstrong\u003edocker\u003c/strong\u003e sur chaque serveur :\u003c/p\u003e\u003cdiv class=\"relative group\"\u003e\u003cbutton type=\"button\" class=\"invisible group-hover:visible absolute top-0 right-0 rounded-md text-xs bg-gray-300 m-3 p-1.5 cursor-pointer leading-none\"\u003eCopier\u003c/button\u003e\u003cpre\u003e\u003ccode class=\"language-bash\"\u003eapt-get update; apt-get upgrade; apt-get dist-upgrade;\napt-get install -y apt-transport-https\ncurl -fsSL https://download.docker.com/linux/ubuntu/gpg | sudo apt-key add -\nsudo add-apt-repository \u0026quot;deb [arch=amd64] https://download.docker.com/linux/ubuntu $(lsb_release -cs) stable\u0026quot;\nsudo apt-get update; sudo apt-get install -y docker-ce\n\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003cp\u003eEnsuite, on initialise Docker Swarm sur le serveur master :\u003c/p\u003e\u003cdiv class=\"relative group\"\u003e\u003cbutton type=\"button\" class=\"invisible group-hover:visible absolute top-0 right-0 rounded-md text-xs bg-gray-300 m-3 p-1.5 cursor-pointer leading-none\"\u003eCopier\u003c/button\u003e\u003cpre\u003e\u003ccode class=\"language-bash\"\u003edocker swarm init --advertise-addr eth0:2377\n\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003cp\u003ePuis, on joint les serveurs workers au serveur master :\u003c/p\u003e\u003cdiv class=\"relative group\"\u003e\u003cbutton type=\"button\" class=\"invisible group-hover:visible absolute top-0 right-0 rounded-md text-xs bg-gray-300 m-3 p-1.5 cursor-pointer leading-none\"\u003eCopier\u003c/button\u003e\u003cpre\u003e\u003ccode class=\"language-bash\"\u003edocker swarm join --token \u0026lt;token\u0026gt; \u0026lt;mondomaine.priv.cloud.scaleway.com\u0026gt;:2377\n\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003cp\u003e\u003cstrong\u003eNote\u003c/strong\u003e: Scaleway change les adresses IP privées lors du redémarrage des serveurs. Pour cette raison je dois faire communiquer les serveurs entre eux par leurs domaines privés qui eux restent fixes. Si vous ne passez pas par Scaleway vous pouvez utiliser des adresses IP directement.\u003c/p\u003e\u003cp\u003ePour la configuration du \u003cstrong\u003eswap\u003c/strong\u003e, voilà les commandes que j\u0026#x27;exécute :\u003c/p\u003e\u003cdiv class=\"relative group\"\u003e\u003cbutton type=\"button\" class=\"invisible group-hover:visible absolute top-0 right-0 rounded-md text-xs bg-gray-300 m-3 p-1.5 cursor-pointer leading-none\"\u003eCopier\u003c/button\u003e\u003cpre\u003e\u003ccode class=\"language-bash\"\u003efallocate -l 2G /swap\nmkswap /swap\necho \u0026quot;/swap  none  swap  sw 0  0\u0026quot; \u0026gt;\u0026gt; /etc/fstab\nswapon -a\necho \u0026quot;vm.swappiness = 10\u0026quot; \u0026gt;\u0026gt; /etc/sysctl.d/99-swap.conf\nsed -i -e \u0026#x27;s/GRUB_CMDLINE_LINUX=\u0026quot;\u0026quot;/GRUB_CMDLINE_LINUX=\u0026quot;cgroup_enable=memory swapaccount=1\u0026quot;/g\u0026#x27; /etc/default/grub\nupdate-grub\n\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003ch2\u003e3. Persistence des données\u003c/h2\u003e\u003cp\u003eUne application \u003cstrong\u003estateful\u003c/strong\u003e, contrairement à une application stateless, a besoin de persister certaines données comme une base de données (des fichiers de configurations ou de simples fichiers images par exemple). On utilise pour ça les \u003cstrong\u003evolumes docker\u003c/strong\u003e. De plus, avec \u003cstrong\u003eDocker Swarm\u003c/strong\u003e, les containers sont volatiles et ne restent pas toujours reliés à un unique serveur. Il faut donc utiliser un \u003ca class=\"\" target=\"_blank\" href=\"https://docs.docker.com/engine/extend/legacy_plugins/#volume-plugins\"\u003evolume driver\u003c/a\u003e.\u003c/p\u003e\u003ch3\u003eUn espace de stockage flexible\u003c/h3\u003e\u003cp\u003eAfin d’éviter d’éparpiller les données et étendre facilement la taille de notre espace de stockage, j’ai créé une \u003cstrong\u003epartition LVM\u003c/strong\u003e (Logical Volume Manager) qui combine plusieurs volumes de données. Au fur et à mesure que l’infrastructure grandit, il est possible d’ajouter nos volumes de données à cette partition.\u003c/p\u003e\u003cp\u003eAvec Scaleway, il est très simple d’ajouter et de relier des volumes de données à un serveur. Une fois nos volumes reliés, nous pouvons les combiner ensemble pour former \u003cstrong\u003eun seul point de montage\u003c/strong\u003e.\u003c/p\u003e\u003cp\u003eL’installation se fait sur notre serveur master :\u003c/p\u003e\u003cdiv class=\"relative group\"\u003e\u003cbutton type=\"button\" class=\"invisible group-hover:visible absolute top-0 right-0 rounded-md text-xs bg-gray-300 m-3 p-1.5 cursor-pointer leading-none\"\u003eCopier\u003c/button\u003e\u003cpre\u003e\u003ccode class=\"language-bash\"\u003eapt-get install -y lvm2\nsystemctl start lvm2-lvmetad.socket\npvcreate /dev/{nbd1,nbd2}\nvgcreate lvm /dev/nbd1 /dev/nbd2\nlvcreate -l 100%FREE -n storage lvm\nmkfs -t ext4 /dev/lvm/storage\necho \u0026quot;/dev/mapper/lvm-storage /mnt ext4 rw,relatime 0 0\u0026quot; \u0026gt;\u0026gt; /etc/fstab\nmount -a\nsed -i -e \u0026#x27;s/use_lvmetad = 1/use_lvmetad = 0/g\u0026#x27; /etc/lvm/lvm.conf\n\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003cp\u003eÀ l’avenir, si vous souhaitez \u003cstrong\u003eagrandir votre espace de stockage\u003c/strong\u003e via d’autres volumes, il suffit simplement d’exécuter les commandes suivantes :\u003c/p\u003e\u003cdiv class=\"relative group\"\u003e\u003cbutton type=\"button\" class=\"invisible group-hover:visible absolute top-0 right-0 rounded-md text-xs bg-gray-300 m-3 p-1.5 cursor-pointer leading-none\"\u003eCopier\u003c/button\u003e\u003cpre\u003e\u003ccode class=\"language-bash\"\u003eumount /mnt\nvgextend lvm /dev/nbd3\nlvextend -l +100%Free /dev/lvm/storage\nresize2fs /dev/lvm/storage\nmount -a\n\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003ch3\u003eVolume driver\u003c/h3\u003e\u003cp\u003eLe \u003ca class=\"\" target=\"_blank\" href=\"https://docs.docker.com/engine/extend/legacy_plugins/#volume-plugins\"\u003evolume driver\u003c/a\u003e que j’ai choisi s’appelle docker-volume-netshare. Chaque application persistera ses données sur un serveur NFS.\u003c/p\u003e\u003cp\u003eOn installe notre \u003cstrong\u003eserveur NFS\u003c/strong\u003e sur notre master :\u003c/p\u003e\u003cdiv class=\"relative group\"\u003e\u003cbutton type=\"button\" class=\"invisible group-hover:visible absolute top-0 right-0 rounded-md text-xs bg-gray-300 m-3 p-1.5 cursor-pointer leading-none\"\u003eCopier\u003c/button\u003e\u003cpre\u003e\u003ccode class=\"language-bash\"\u003esudo apt-get install -y nfs-kernel-server\nsudo mkdir /mnt/data\n\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003cp\u003ePuis on autorise tous les serveurs à s’y connecter :\u003c/p\u003e\u003cdiv class=\"relative group\"\u003e\u003cbutton type=\"button\" class=\"invisible group-hover:visible absolute top-0 right-0 rounded-md text-xs bg-gray-300 m-3 p-1.5 cursor-pointer leading-none\"\u003eCopier\u003c/button\u003e\u003cpre\u003e\u003ccode class=\"language-bash\"\u003e# /etc/exports\n/mnt/data 127.0.0.1(rw,sync,no_subtree_check,no_root_squash) worker-01.priv.cloud.scaleway.com(rw,sync,no_subtree_check,no_root_squash) worker-02(rw,sync,no_subtree_check,no_root_squash)    \n\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003cp\u003eOn redémarre notre serveur afin d’appliquer notre configuration :\u003c/p\u003e\u003cdiv class=\"relative group\"\u003e\u003cbutton type=\"button\" class=\"invisible group-hover:visible absolute top-0 right-0 rounded-md text-xs bg-gray-300 m-3 p-1.5 cursor-pointer leading-none\"\u003eCopier\u003c/button\u003e\u003cpre\u003e\u003ccode class=\"language-bash\"\u003esudo systemctl restart nfs-kernel-server\n\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003cp\u003ePuis on installe sur tous les serveurs le package nfs-common et notre \u003cstrong\u003evolume\u003c/strong\u003e driver docker-volume-netshare :\u003c/p\u003e\u003cdiv class=\"relative group\"\u003e\u003cbutton type=\"button\" class=\"invisible group-hover:visible absolute top-0 right-0 rounded-md text-xs bg-gray-300 m-3 p-1.5 cursor-pointer leading-none\"\u003eCopier\u003c/button\u003e\u003cpre\u003e\u003ccode class=\"language-bash\"\u003esudo apt-get install -y nfs-common\n\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003cdiv class=\"relative group\"\u003e\u003cbutton type=\"button\" class=\"invisible group-hover:visible absolute top-0 right-0 rounded-md text-xs bg-gray-300 m-3 p-1.5 cursor-pointer leading-none\"\u003eCopier\u003c/button\u003e\u003cpre\u003e\u003ccode class=\"language-bash\"\u003esudo wget -O /usr/bin/docker-volume-netshare https://github.com/ContainX/docker-volume-netshare/releases/download/v0.35/docker-volume-netshare_0.35_linux_amd64-bin\nsudo chmod +x /usr/bin/docker-volume-netshare\n\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003cp\u003eOn crée \u003cstrong\u003eun service\u003c/strong\u003e docker-volume-netshare qui sera lancé à chaque démarrage serveur :\u003c/p\u003e\u003cdiv class=\"relative group\"\u003e\u003cbutton type=\"button\" class=\"invisible group-hover:visible absolute top-0 right-0 rounded-md text-xs bg-gray-300 m-3 p-1.5 cursor-pointer leading-none\"\u003eCopier\u003c/button\u003e\u003cpre\u003e\u003ccode class=\"language-service\"\u003e# /etc/systemd/system/docker-volume-netshare.service\n[Unit]\nDescription=Docker NFS, AWS EFS \u0026amp; Samba/CIFS Volume Plugin\nDocumentation=https://github.com/gondor/docker-volume-netshare\nWants=network-online.target\nAfter=network-online.target\nBefore=docker.service\n\n[Service]\nExecStart=/usr/bin/docker-volume-netshare nfs\nStandardOutput=syslog\n\n[Install]\nWantedBy=multi-user.target\n\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003cdiv class=\"relative group\"\u003e\u003cbutton type=\"button\" class=\"invisible group-hover:visible absolute top-0 right-0 rounded-md text-xs bg-gray-300 m-3 p-1.5 cursor-pointer leading-none\"\u003eCopier\u003c/button\u003e\u003cpre\u003e\u003ccode class=\"language-bash\"\u003esystemctl enable docker-volume-netshare.service\nsystemctl start docker-volume-netshare.service\n\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003cp\u003ePour vérifier si tout fonctionne correctement, vous pouvez créer un volume « test » :\u003c/p\u003e\u003cdiv class=\"relative group\"\u003e\u003cbutton type=\"button\" class=\"invisible group-hover:visible absolute top-0 right-0 rounded-md text-xs bg-gray-300 m-3 p-1.5 cursor-pointer leading-none\"\u003eCopier\u003c/button\u003e\u003cpre\u003e\u003ccode class=\"language-bash\"\u003edocker volume create --driver nfs --name=test --opt share=127.0.0.1:/mnt/data --opt create=true\n\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003cp\u003ePuis créer un fichier « test » depuis un container :\u003c/p\u003e\u003cdiv class=\"relative group\"\u003e\u003cbutton type=\"button\" class=\"invisible group-hover:visible absolute top-0 right-0 rounded-md text-xs bg-gray-300 m-3 p-1.5 cursor-pointer leading-none\"\u003eCopier\u003c/button\u003e\u003cpre\u003e\u003ccode class=\"language-bash\"\u003edocker run --rm -v test:/mount alpine touch /mount/test\n\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003cp\u003eCe fichier devrait apparaître dans le répertoire /mnt/data de votre serveur master.\u003c/p\u003e\u003ch2\u003e4. Sauvegardes automatisées\u003c/h2\u003e\u003cp\u003e\u003cstrong\u003eObjectif\u003c/strong\u003e : Créer un système de sauvegarde journalier de tous les \u003cstrong\u003evolumes\u003c/strong\u003e.\u003c/p\u003e\u003cp\u003ePour sauvegarder nos volumes il nous suffit de sauvegarder notre dossier /mnt/data avec notre outil de backup préféré (borg, restic, duplicity, etc.).\u003c/p\u003e\u003cp\u003ePersonnellement j’utilise \u003cstrong\u003erestic\u003c/strong\u003e :\u003c/p\u003e\u003cdiv class=\"relative group\"\u003e\u003cbutton type=\"button\" class=\"invisible group-hover:visible absolute top-0 right-0 rounded-md text-xs bg-gray-300 m-3 p-1.5 cursor-pointer leading-none\"\u003eCopier\u003c/button\u003e\u003cpre\u003e\u003ccode class=\"language-bash\"\u003ewget https://github.com/restic/restic/releases/download/v0.9.3/restic_0.9.3_linux_amd64.bz2\nbzip2 -d restic_0.9.3_linux_amd64.bz2\nmv restic_0.9.3_linux_amd64 /usr/local/bin/restic\nchmod +x /usr/local/bin/restic\n\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003cp\u003eLe processus de sauvegarde est très simple avec restic :\u003c/p\u003e\u003cdiv class=\"relative group\"\u003e\u003cbutton type=\"button\" class=\"invisible group-hover:visible absolute top-0 right-0 rounded-md text-xs bg-gray-300 m-3 p-1.5 cursor-pointer leading-none\"\u003eCopier\u003c/button\u003e\u003cpre\u003e\u003ccode class=\"language-bash\"\u003erestic -r \u0026lt;repository\u0026gt; init\nrestic -r \u0026lt;repository\u0026gt; backup /mnt/data\n\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003cp\u003eIl existe plusieurs types de \u003cstrong\u003erepository\u003c/strong\u003e : local, S3, sftp, rclone, etc. Personnellement j’utilise \u003cstrong\u003eS3\u003c/strong\u003e, car Scaleway propose un \u003cstrong\u003eObject Storage\u003c/strong\u003e comme AWS, du coup j’en profite.\u003c/p\u003e\u003cp\u003eOn automatise ensuite la sauvegarde avec une \u003cstrong\u003etâche cron\u003c/strong\u003e :\u003c/p\u003e\u003cdiv class=\"relative group\"\u003e\u003cbutton type=\"button\" class=\"invisible group-hover:visible absolute top-0 right-0 rounded-md text-xs bg-gray-300 m-3 p-1.5 cursor-pointer leading-none\"\u003eCopier\u003c/button\u003e\u003cpre\u003e\u003ccode class=\"language-bash\"\u003e# crontab -e\n0 0 * * * /usr/local/bin/restic -r \u0026lt;repository\u0026gt; backup /mnt/data\n\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003ch3\u003eRestauration\u003c/h3\u003e\u003cp\u003eDans le cas où vous souhaitez récupérer une sauvegarde précédente :\u003c/p\u003e\u003cdiv class=\"relative group\"\u003e\u003cbutton type=\"button\" class=\"invisible group-hover:visible absolute top-0 right-0 rounded-md text-xs bg-gray-300 m-3 p-1.5 cursor-pointer leading-none\"\u003eCopier\u003c/button\u003e\u003cpre\u003e\u003ccode class=\"language-bash\"\u003erestic -r \u0026lt;repository\u0026gt; snapshots\nrestic -r \u0026lt;repository\u0026gt; restore \u0026lt;snapshotID\u0026gt; -t restore\n\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003ch2\u003e5. Reverse-proxy et Let’s Encrypt\u003c/h2\u003e\u003cp\u003e\u003cstrong\u003eObjectif\u003c/strong\u003e: Configurer un \u003cstrong\u003ereverse proxy\u003c/strong\u003e pour accéder à nos applications via un \u003cstrong\u003eunique point d’entrée\u003c/strong\u003e.\u003c/p\u003e\u003cp\u003ePersonnellement, j’utilise \u003cstrong\u003eTraefik\u003c/strong\u003e, qui est compatible avec \u003cstrong\u003eDocker Swarm\u003c/strong\u003e.\u003c/p\u003e\u003cp\u003eOn crée \u003cstrong\u003eun network\u003c/strong\u003e que l’on nomme par exemple \u003cstrong\u003etraefik-net,\u003c/strong\u003e il sera utilisé pour relier de manière automatique chaque application à \u003cstrong\u003eTraefik\u003c/strong\u003e à l’aide des \u003cstrong\u003elabels\u003c/strong\u003e.\u003c/p\u003e\u003cdiv class=\"relative group\"\u003e\u003cbutton type=\"button\" class=\"invisible group-hover:visible absolute top-0 right-0 rounded-md text-xs bg-gray-300 m-3 p-1.5 cursor-pointer leading-none\"\u003eCopier\u003c/button\u003e\u003cpre\u003e\u003ccode class=\"language-bash\"\u003edocker network create --driver=overlay traefik-net\n\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003cp\u003ePuis on déploie \u003cstrong\u003eTraefik\u003c/strong\u003e uniquement sur notre serveur master :\u003c/p\u003e\u003cdiv class=\"relative group\"\u003e\u003cbutton type=\"button\" class=\"invisible group-hover:visible absolute top-0 right-0 rounded-md text-xs bg-gray-300 m-3 p-1.5 cursor-pointer leading-none\"\u003eCopier\u003c/button\u003e\u003cpre\u003e\u003ccode class=\"language-yml\"\u003e# traefik.yml\n\nversion: \u0026quot;3.3\u0026quot;\nservices:\n  traefik:\n    image: traefik\n    command: --docker \\\n      --docker.swarmMode \\\n      --docker.watch\n    ports:\n      - \u0026quot;80:80\u0026quot;\n    volumes:\n      - /var/run/docker.sock:/var/run/docker.sock\n    deploy:\n      placement:\n        constraints: [node.role==manager]\n\nnetworks:\n  default:\n    external:\n      name: traefik-net\n\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003cdiv class=\"relative group\"\u003e\u003cbutton type=\"button\" class=\"invisible group-hover:visible absolute top-0 right-0 rounded-md text-xs bg-gray-300 m-3 p-1.5 cursor-pointer leading-none\"\u003eCopier\u003c/button\u003e\u003cpre\u003e\u003ccode class=\"language-bash\"\u003edocker stack deploy -c traefik.yml traefik\n\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003cp\u003eEnfin, pour relier une application à notre \u003cstrong\u003ereverse proxy\u003c/strong\u003e, on peut créer un \u003cstrong\u003eservice\u003c/strong\u003e docker avec des \u003cstrong\u003elabels\u003c/strong\u003e qui indiqueront à \u003cstrong\u003eTraefik\u003c/strong\u003e de diriger le traffic HTTP du domaine \u003ca class=\"\" target=\"_blank\" href=\"https://johackim.com\"\u003ejohackim.com\u003c/a\u003e sur le(s) bon(s) container(s) :\u003c/p\u003e\u003cdiv class=\"relative group\"\u003e\u003cbutton type=\"button\" class=\"invisible group-hover:visible absolute top-0 right-0 rounded-md text-xs bg-gray-300 m-3 p-1.5 cursor-pointer leading-none\"\u003eCopier\u003c/button\u003e\u003cpre\u003e\u003ccode class=\"language-bash\"\u003edocker service create --name blog --network traefik-net -l traefik.port=2368 -l traefik.frontend.rule=Host:johackim.com -l traefik.enable=true ghost\n\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003ch3\u003eLet’s Encrypt\u003c/h3\u003e\u003cp\u003ePour \u003cstrong\u003eautomatiser la création de certificats SSL\u003c/strong\u003e des services exposés à l’extérieur de mon cluster, j’ai configuré \u003cstrong\u003eTraefik\u003c/strong\u003e avec ce fichier de configuration :\u003c/p\u003e\u003cdiv class=\"relative group\"\u003e\u003cbutton type=\"button\" class=\"invisible group-hover:visible absolute top-0 right-0 rounded-md text-xs bg-gray-300 m-3 p-1.5 cursor-pointer leading-none\"\u003eCopier\u003c/button\u003e\u003cpre\u003e\u003ccode class=\"language-toml\"\u003e# traefik.toml\n\ndebug = true\nlogLevel = \u0026quot;DEBUG\u0026quot;\ndefaultEntryPoints = [\u0026quot;https\u0026quot;,\u0026quot;http\u0026quot;]\n\n[entryPoints]\n  [entryPoints.http]\n  address = \u0026quot;:80\u0026quot;\n    [entryPoints.http.redirect]\n    entryPoint = \u0026quot;https\u0026quot;\n  [entryPoints.https]\n  address = \u0026quot;:443\u0026quot;\n    [entryPoints.https.tls]\n\n[acme]\nemail = \u0026quot;contact@example.com\u0026quot;\nstorage = \u0026quot;acme.json\u0026quot;\nacmeLogging = true\nentryPoint = \u0026quot;https\u0026quot;\nonHostRule = true\n\n[acme.httpChallenge]\n  entryPoint = \u0026quot;http\u0026quot;\n\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003ch2\u003e6. Infrastructure as Code\u003c/h2\u003e\u003cp\u003eToutes les applications sont définies sous forme de code. \u003cstrong\u003eUn fichier YAML\u003c/strong\u003e représente tout ce que contient une application (\u003cstrong\u003eservices, volumes, networks\u003c/strong\u003e).\u003c/p\u003e\u003cp\u003eVoici comme exemple le fichier ghost.yml que j’utilise pour le déploiement de mon blog :\u003c/p\u003e\u003cdiv class=\"relative group\"\u003e\u003cbutton type=\"button\" class=\"invisible group-hover:visible absolute top-0 right-0 rounded-md text-xs bg-gray-300 m-3 p-1.5 cursor-pointer leading-none\"\u003eCopier\u003c/button\u003e\u003cpre\u003e\u003ccode class=\"language-yml\"\u003e# ghost.yml\n\nversion: \u0026#x27;3\u0026#x27;\n\nservices:\n  web:\n    image: ghost:2.4.0\n    volumes:\n      - ghost:/var/lib/ghost/content:nocopy\n    environment:\n      url: ${SCHEME:-http}://${DOMAIN:?err}\n    deploy:\n      labels:\n        traefik.port: 2368\n        traefik.frontend.rule: Host:${DOMAIN:?err}\n        traefik.enable: \u0026quot;true\u0026quot;\n\nvolumes:\n  ghost:\n    driver: nfs\n    driver_opts:\n      share: master.priv.cloud.scaleway.com:/mnt/data\n      create: \u0026quot;true\u0026quot;\n\nnetworks:\n  default:\n    external:\n      name: traefik-net\n\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003cp\u003eEn une seule commande, je peux déployer un blog ghost sous le nom de domaine que je souhaite, et avec un certificat ssl automatiquement attribué :\u003c/p\u003e\u003cdiv class=\"relative group\"\u003e\u003cbutton type=\"button\" class=\"invisible group-hover:visible absolute top-0 right-0 rounded-md text-xs bg-gray-300 m-3 p-1.5 cursor-pointer leading-none\"\u003eCopier\u003c/button\u003e\u003cpre\u003e\u003ccode class=\"language-bash\"\u003eSCHEME=https DOMAIN=johackim.com docker stack deploy -c ghost.yml blog\n\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003cp\u003eJ’ai créé d’autres stacks que \u003cstrong\u003eGhost\u003c/strong\u003e, je vous invite à vous rendre sur \u003ca class=\"\" target=\"_blank\" href=\"https://github.com/ethibox/awesome-stacks/\"\u003ece repository\u003c/a\u003e si vous désirez en voir d’autres.\u003c/p\u003e\u003ch2\u003e7. Monitoring, alerting et logging\u003c/h2\u003e\u003cp\u003ePour \u003cstrong\u003emonitorer\u003c/strong\u003e tous mes serveurs, pour être \u003cstrong\u003ealerté\u003c/strong\u003e à chaque fois qu’une application ne renvoie pas un \u003cstrong\u003ecode 200\u003c/strong\u003e ou qu’un \u003cstrong\u003eCPU, RAM, Disque\u003c/strong\u003e dépasse les 95% d’utilisation. Je me suis créé une \u003ca class=\"\" target=\"_blank\" href=\"https://raw.githubusercontent.com/ethibox/awesome-stacks/ee0f0474bb8237b32f1a0a84a12275ed855362d4/monitoring.yml\"\u003estack avec grafana, prometheus et alertmanager\u003c/a\u003e.\u003c/p\u003e\u003cp\u003e\u003cimg src=\"https://i.imgur.com/lO3QlRr.png\" alt=\"Dashboard Grafana\"/\u003e\u003c/p\u003e\u003cp\u003eEt d’une commande, je peux tout installer :\u003c/p\u003e\u003cdiv class=\"relative group\"\u003e\u003cbutton type=\"button\" class=\"invisible group-hover:visible absolute top-0 right-0 rounded-md text-xs bg-gray-300 m-3 p-1.5 cursor-pointer leading-none\"\u003eCopier\u003c/button\u003e\u003cpre\u003e\u003ccode class=\"language-bash\"\u003eDOMAIN_GRAFANA=grafana.mondomaine.fr DOMAIN_PROMETHEUS=prometheus.mondomaine.fr docker stack deploy -c monitoring.yml monitoring\n\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003cp\u003e\u003ca class=\"\" target=\"_blank\" href=\"https://github.com/ethibox/awesome-stacks/blob/91c336d4c42b3b2dd056a15b65c1d996ce08c236/elastic.yml\"\u003eLa stack elastic\u003c/a\u003e quant à elle, va me servir à \u003cstrong\u003elogger tout le traffic HTTP entrant\u003c/strong\u003e sur \u003cstrong\u003eTraefik\u003c/strong\u003e et \u003cstrong\u003ecollecter les syslog\u003c/strong\u003e de chaque serveur.\u003c/p\u003e\u003cdiv class=\"relative group\"\u003e\u003cbutton type=\"button\" class=\"invisible group-hover:visible absolute top-0 right-0 rounded-md text-xs bg-gray-300 m-3 p-1.5 cursor-pointer leading-none\"\u003eCopier\u003c/button\u003e\u003cpre\u003e\u003ccode class=\"language-bash\"\u003eDOMAIN=kibana.mondomaine.fr docker stack deploy -c elastic.yml elastic\n\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003ch2\u003e8. Sécurité\u003c/h2\u003e\u003cp\u003eEn termes de sécurité, je provisionne tous mes serveurs avec un \u003ca class=\"\" target=\"_blank\" href=\"https://github.com/johackim/ansible-personal\"\u003eplaybook\u003c/a\u003e Ansible. Concrètement, je configure tous mes serveurs avec un \u003cstrong\u003eIPS\u003c/strong\u003e (fail2ban), un \u003cstrong\u003efirewall\u003c/strong\u003e (iptables) et des \u003cstrong\u003erègles de system hardening\u003c/strong\u003e.\u003c/p\u003e\u003cdiv class=\"relative group\"\u003e\u003cbutton type=\"button\" class=\"invisible group-hover:visible absolute top-0 right-0 rounded-md text-xs bg-gray-300 m-3 p-1.5 cursor-pointer leading-none\"\u003eCopier\u003c/button\u003e\u003cpre\u003e\u003ccode class=\"language-bash\"\u003eansible-playbook playbook.yml -u root -i \u0026lt;PUBLIC_IP\u0026gt;,\n\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003cp\u003eJe crée aussi des règles de sécurité avec les \u003cstrong\u003esecurity group\u003c/strong\u003e de Scaleway, puis des \u003cstrong\u003eheaders HTTP sécurisés\u003c/strong\u003e pour chaque application :\u003c/p\u003e\u003cdiv class=\"relative group\"\u003e\u003cbutton type=\"button\" class=\"invisible group-hover:visible absolute top-0 right-0 rounded-md text-xs bg-gray-300 m-3 p-1.5 cursor-pointer leading-none\"\u003eCopier\u003c/button\u003e\u003cpre\u003e\u003ccode class=\"language-bash\"\u003edocker service update \u0026lt;name_app\u0026gt; --label-add traefik.frontend.headers.customResponseHeaders=\u0026quot;X-XSS-Protection: 1; mode=block\u0026quot;\n\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003ch2\u003eConclusion\u003c/h2\u003e\u003cp\u003eDe manière subjective, c’est la solution idéale pour moi, après avoir testé plusieurs solutions (\u003cstrong\u003eKubernetes, Helm, Ark, Ceph, Rook, Minio et Rexray\u003c/strong\u003e) c’est celle qui dans mon cas est la plus \u003cstrong\u003eaccessible, maintenable, scalable\u003c/strong\u003e et \u003cstrong\u003eperformante\u003c/strong\u003e.\u003c/p\u003e\u003cp\u003eSa scalabilité me permet d’\u003cstrong\u003eéviter d’investir trop d’argent\u003c/strong\u003e dans de très gros serveurs et d’\u003cstrong\u003eévoluer proportionnellement\u003c/strong\u003e à la demande des clients.\u003c/p\u003e\u003cp\u003eJe pense avoir créé une bonne base, il me reste sûrement encore beaucoup de choses à améliorer, dont par exemple :\u003c/p\u003e\u003cul\u003e\n\u003cli\u003eAjouter des \u003cstrong\u003e\u003ca class=\"\" target=\"_blank\" href=\"https://docs.docker.com/compose/compose-file/#healthcheck\"\u003ehealthcheck\u003c/a\u003e\u003c/strong\u003e et \u003cstrong\u003e\u003ca class=\"\" target=\"_blank\" href=\"https://docs.docker.com/config/containers/resource_constraints/\"\u003elimite de ressource\u003c/a\u003e\u003c/strong\u003e Docker\u003c/li\u003e\n\u003cli\u003eMe créer un \u003cstrong\u003eSiem\u003c/strong\u003e avec la stack \u003cstrong\u003eElastic\u003c/strong\u003e et \u003cstrong\u003eSurricata\u003c/strong\u003e\u003c/li\u003e\n\u003cli\u003eGénérer de manière aléatoire et automatique les mots de passes dans des \u003cstrong\u003edocker secrets\u003c/strong\u003e.\u003c/li\u003e\n\u003cli\u003e\u003cstrong\u003eAuto-héberger\u003c/strong\u003e toute l’infrastucture chez moi sur mon propre matériel, pour ne plus dépendre de \u003cstrong\u003eScaleway\u003c/strong\u003e.\u003c/li\u003e\n\u003cli\u003eUn \u003cstrong\u003estockage distribué\u003c/strong\u003e\u003c/li\u003e\n\u003c/ul\u003e\u003cp\u003eN’hésitez pas à me dire dans les commentaires si vous avez des suggestions d’améliorations !\u003c/p\u003e\u003chr/\u003e\u003cp\u003eRéférences :\u003c/p\u003e\u003cul\u003e\n\u003cli\u003e\n\u003ca class=\"\" href=\"/hebergement-web\"\u003eHébergement web\u003c/a\u003e\n\n\u003c/li\u003e\n\u003c/ul\u003e\u003c/div\u003e","isIndex":false,"file":"Mon infrastructure en tant qu'hébergeur web indépendant.md","fileName":"Mon infrastructure en tant qu'hébergeur web indépendant","title":"Mon infrastructure en tant qu'hébergeur web indépendant","comments":true,"permalink":"infrastructure-hebergeur-web-independant","datePublished":"2019-01-01T18:40","dateUpdated":"2019-01-01T18:40","description":"En tant que membre des CHATONS (Collectif des Hébergeurs Alternatifs, Transparents, Ouverts, Neutres et Solidaires) et étant seul à maintenir les services de mes clients, je me suis conçu une infrastructure sécurisée, performante, scalable, automatisée et facile à maintenir.","publish":true,"rss":true},"__N_SSG":true},"page":"/[[...permalink]]","query":{"permalink":["infrastructure-hebergeur-web-independant"]},"buildId":"37kNBSZEarMk2zx1j6Bqx","isFallback":false,"gsp":true,"scriptLoader":[]}</script></body></html>