<!DOCTYPE html><html lang="fr"><head><meta charSet="utf-8" data-next-head=""/><meta name="viewport" content="width=device-width" data-next-head=""/><meta name="twitter:card" content="summary_large_image" data-next-head=""/><meta name="twitter:site" content="@_johackim" data-next-head=""/><meta name="twitter:creator" content="@_johackim" data-next-head=""/><meta property="og:url" content="https://johackim.com" data-next-head=""/><meta property="og:locale" content="fr_FR" data-next-head=""/><meta property="og:site_name" content="johackim" data-next-head=""/><title data-next-head="">Mon infrastructure en tant qu&#x27;hébergeur web indépendant | Johackim - Hacker indépendant</title><meta name="robots" content="index,follow" data-next-head=""/><meta name="description" content="En tant que membre des CHATONS (Collectif des Hébergeurs Alternatifs, Transparents, Ouverts, Neutres et Solidaires) et étant seul à maintenir les services de mes clients, je me suis conçu une infrastructure sécurisée, performante, scalable, automatisée et facile à maintenir." data-next-head=""/><meta property="og:title" content="Mon infrastructure en tant qu&#x27;hébergeur web indépendant" data-next-head=""/><meta property="og:description" content="En tant que membre des CHATONS (Collectif des Hébergeurs Alternatifs, Transparents, Ouverts, Neutres et Solidaires) et étant seul à maintenir les services de mes clients, je me suis conçu une infrastructure sécurisée, performante, scalable, automatisée et facile à maintenir." data-next-head=""/><meta property="og:type" content="article" data-next-head=""/><meta property="article:published_time" content="2019-01-01T18:40:00.000Z" data-next-head=""/><meta property="article:modified_time" content="2019-01-01T18:40:00.000Z" data-next-head=""/><meta property="og:image" content="https://johackim.com/covers/infrastructure-hebergeur-web-independant.jpg" data-next-head=""/><link rel="preload" href="/_next/static/media/47cbc4e2adbc5db9-s.p.woff2" as="font" type="font/woff2" crossorigin="anonymous" data-next-font="size-adjust"/><link rel="preload" href="/_next/static/css/a1ff13823887c96f.css" as="style"/><script type="application/ld+json" data-next-head="">{"@context":"https://schema.org","@type":"article","datePublished":"2019-01-01T18:40:00.000Z","description":"En tant que membre des CHATONS (Collectif des Hébergeurs Alternatifs, Transparents, Ouverts, Neutres et Solidaires) et étant seul à maintenir les services de mes clients, je me suis conçu une infrastructure sécurisée, performante, scalable, automatisée et facile à maintenir.","mainEntityOfPage":{"@type":"WebPage","@id":"https://johackim.com/infrastructure-hebergeur-web-independant"},"headline":"Mon infrastructure en tant qu&apos;hébergeur web indépendant","image":["https://johackim.com/covers/infrastructure-hebergeur-web-independant.jpg"],"dateModified":"2019-01-01T18:40:00.000Z","author":{"@type":"Person","name":"Johackim"}}</script><link rel="stylesheet" href="/_next/static/css/a1ff13823887c96f.css" data-n-g=""/><noscript data-n-css=""></noscript><script defer="" noModule="" src="/_next/static/chunks/polyfills-42372ed130431b0a.js"></script><script src="/_next/static/chunks/webpack-8cac0b4b405cede1.js" defer=""></script><script src="/_next/static/chunks/framework-b1e5f14688f9ffe6.js" defer=""></script><script src="/_next/static/chunks/main-d50aa070ebba4b51.js" defer=""></script><script src="/_next/static/chunks/pages/_app-5505c828b8556d55.js" defer=""></script><script src="/_next/static/chunks/92-8aaa74fb1c3ae5c6.js" defer=""></script><script src="/_next/static/chunks/pages/%5B%5B...permalink%5D%5D-04cf9b070610d4d9.js" defer=""></script><script src="/_next/static/rai-Pzq2t03wyRHvrWgH-/_buildManifest.js" defer=""></script><script src="/_next/static/rai-Pzq2t03wyRHvrWgH-/_ssgManifest.js" defer=""></script><style id="__jsx-2490803925">html{font-family:'Roboto', 'Roboto Fallback'}</style></head><body><link rel="preload" as="image" href="https://i.imgur.com/e6l8DD5.png"/><link rel="preload" as="image" href="https://i.imgur.com/lO3QlRr.png"/><div id="__next"><header class="flex shadow-md inset-x-0 h-16 items-center z-30 text-gray-700 bg-white fixed top-0"><div class="container m-auto flex items-center justify-between flex-wrap px-4 lg:max-w-screen-lg"><a href="/"><div class="flex items-center"><img alt="logo" loading="lazy" width="48" height="48" decoding="async" data-nimg="1" class="rounded-full w-12" style="color:transparent" src="/profile.jpg"/><div class="ml-2"><div class="font-bold leading-none">Johackim</div><div class="text-sm leading-none">Hacker indépendant</div></div></div></a><nav class="grid grid-flow-col gap-4 items-center"><a class="hover:underline hidden md:block" href="/">Accueil</a><a class="hover:underline hidden md:block" href="/articles">Articles</a><a href="/newsletter"><button type="button" class="bg-cyan-700 text-white hover:text-white hover:bg-cyan-800 px-2.5 py-1.5 rounded-md cursor-pointer">S&#x27;abonner</button></a></nav></div></header><main class="lg:max-w-screen-lg m-auto px-4"><div class="bg-cyan-600 h-1 z-30 fixed inset-0" style="width:0%"></div><div class="md:border md:border-gray-200 mt-20"><h1 class="h-64 flex flex-col justify-center relative border-b border-gray-200"><span class="absolute inset-0 bg-gray-100 opacity-80 z-10"></span><span class="transform text-center font-bold px-4 text-4xl text-gray-600 break-words z-20">Mon infrastructure en tant qu&#x27;hébergeur web indépendant</span></h1><div class="text-xs my-4 md:px-4 text-gray-700"><span>Mis à jour le </span><span>mardi 1 janvier 2019</span><span> par <a class="underline text-cyan-700" href="/a-propos">johackim</a></span></div><article class="prose break-words prose-a:font-normal prose-a:text-cyan-700 prose-a:break-words marker:text-gray-700 prose-code:font-normal prose-code:break-words prose-inline-code:px-1.5 prose-inline-code:py-0.5 prose-code:whitespace-pre-wrap prose-code:text-xs prose-code:bg-gray-200 prose-code:rounded-md prose-pre:bg-gray-200 prose-pre:text-gray-700 prose-pre:overflow-x-auto max-w-none px-0 py-4 md:p-4 prose-code:before:hidden prose-code:after:hidden prose-mark:bg-gray-300 prose-td:border-gray-300 prose-td:border prose-td:px-4 prose-th:border prose-th:border-gray-300 prose-th:px-4 prose-th:py-2"><p>Je me suis récemment donné comme projet de devenir hébergeur indépendant chez les <strong>CHATONS</strong> (le <strong>C</strong>ollectif des <strong>H</strong>ébergeurs <strong>A</strong>lternatifs, <strong>T</strong>ransparents, <strong>O</strong>uverts, <strong>N</strong>eutres et <strong>S</strong>olidaires). Étant seul à maintenir les services de mes clients, j’ai dû concevoir une infrastructure <strong>sécurisée</strong>, <strong>performante</strong>, <strong>scalable</strong>, <strong>automatisée</strong> et <strong>facile à maintenir</strong>. Je vais à travers cet article vous décrire les étapes à suivre pour monter ce type d’infrastructure.</p>
<h2>1. Présentation de l&#x27;infrastructure</h2>
<p>Dans cette infrastructure, chaque application tourne sous forme d’un ou plusieurs conteneurs répartis sur un ou plusieurs serveurs selon leurs ressources disponibles.</p>
<p><img src="https://i.imgur.com/e6l8DD5.png" alt="Infrastructure"/></p>
<p>Les <strong>conteneurs</strong> permettent d’<strong>accélérer et faciliter le déploiement des applications</strong>, ils contiennent toutes les dépendances d’une application et sont indépendants vis-à-vis de l’infrastructure hôte. Additionné à un orchestrateur, par exemple <strong>Docker Swarm</strong>, on dispose d’un système qui exécute, coordonne et <strong>gère entièrement le cycle de vie de nos applications</strong>.</p>
<p>Aujourd’hui je démarre mon infrastructure avec trois petits serveurs, demain elle pourra <strong>évoluer facilement</strong> suivant l’augmentation des demandes clients.</p>
<p>Plutôt que de gérer mon infrastructure sous forme de <strong>tâches manuelles et répétitives</strong>, une grande partie est gérée à l’aide de <strong>fichiers de définition</strong> que je versionne. Dans mon cas, il s’agit principalement de fichiers <strong>YAML</strong>.</p>
<p>Si jamais tous mes serveurs venaient à être stoppés ou supprimés inintentionnellement, je peux à priori tout restaurer en moins d’une heure du moment que je dispose des <strong>backups</strong>.</p>
<p>Une fois l’infrastructure mise en place, il est possible de démarrer une application en seulement une ligne de commande, par exemple :</p>
<ul>
<li>Un <strong>tchat</strong> (ex : rocket.chat)</li>
<li>Un <strong>blog</strong> (ex : WordPress, Joomla, Ghost)</li>
<li>Un <strong>site e-commerce</strong> (ex : PrestaShop)</li>
<li>Un <strong>espace de stockage</strong> (ex : ownCloud, Nextcloud)</li>
<li>Un <strong>système de facturation</strong> (ex : Invoice Ninja)</li>
<li>Un <strong>système de monitoring et d’alerting</strong> (ex : Grafana + Prometheus + Alertmanager)</li>
</ul>
<p>Le tout avec un <strong>nom de domaine</strong> et un <strong>certicat SSL</strong> associé automatiquement.</p>
<h2>2. Déploiement des serveurs</h2>
<p>Aujourd’hui je dispose de <strong>trois serveurs Ubuntu Xenial chez Scaleway</strong>. <strong>Un serveur <a class="" target="_blank" href="https://scaleway.com/pricing/#anchor_baremetal">C2S</a></strong> en tant que master et <strong>deux serveurs <a class="" target="_blank" href="https://scaleway.com/pricing/#anchor_starter">START1-S</a></strong> en tant que workers. Si vous le souhaitez, vous pouvez commencer avec un seul serveur dans un premier temps. De même, il est tout à fait envisageable de créer ce type d’infrastructure sur votre propre matériel physique si vous en avez les moyens.</p>
<p>Première étape on installe <strong>docker</strong> sur chaque serveur :</p>
<div class="relative group"><button type="button" class="invisible group-hover:visible absolute top-0 right-0 rounded-md text-xs bg-gray-300 m-3 p-1.5 cursor-pointer leading-none">Copier</button><pre><code class="language-bash">apt-get update; apt-get upgrade; apt-get dist-upgrade;
apt-get install -y apt-transport-https
curl -fsSL https://download.docker.com/linux/ubuntu/gpg | sudo apt-key add -
sudo add-apt-repository &quot;deb [arch=amd64] https://download.docker.com/linux/ubuntu $(lsb_release -cs) stable&quot;
sudo apt-get update; sudo apt-get install -y docker-ce
</code></pre></div>
<p>Ensuite, on initialise Docker Swarm sur le serveur master :</p>
<div class="relative group"><button type="button" class="invisible group-hover:visible absolute top-0 right-0 rounded-md text-xs bg-gray-300 m-3 p-1.5 cursor-pointer leading-none">Copier</button><pre><code class="language-bash">docker swarm init --advertise-addr eth0:2377
</code></pre></div>
<p>Puis, on joint les serveurs workers au serveur master :</p>
<div class="relative group"><button type="button" class="invisible group-hover:visible absolute top-0 right-0 rounded-md text-xs bg-gray-300 m-3 p-1.5 cursor-pointer leading-none">Copier</button><pre><code class="language-bash">docker swarm join --token &lt;token&gt; &lt;mondomaine.priv.cloud.scaleway.com&gt;:2377
</code></pre></div>
<p><strong>Note</strong>: Scaleway change les adresses IP privées lors du redémarrage des serveurs. Pour cette raison je dois faire communiquer les serveurs entre eux par leurs domaines privés qui eux restent fixes. Si vous ne passez pas par Scaleway vous pouvez utiliser des adresses IP directement.</p>
<p>Pour la configuration du <strong>swap</strong>, voilà les commandes que j&#x27;exécute :</p>
<div class="relative group"><button type="button" class="invisible group-hover:visible absolute top-0 right-0 rounded-md text-xs bg-gray-300 m-3 p-1.5 cursor-pointer leading-none">Copier</button><pre><code class="language-bash">fallocate -l 2G /swap
mkswap /swap
echo &quot;/swap  none  swap  sw 0  0&quot; &gt;&gt; /etc/fstab
swapon -a
echo &quot;vm.swappiness = 10&quot; &gt;&gt; /etc/sysctl.d/99-swap.conf
sed -i -e &#x27;s/GRUB_CMDLINE_LINUX=&quot;&quot;/GRUB_CMDLINE_LINUX=&quot;cgroup_enable=memory swapaccount=1&quot;/g&#x27; /etc/default/grub
update-grub
</code></pre></div>
<h2>3. Persistence des données</h2>
<p>Une application <strong>stateful</strong>, contrairement à une application stateless, a besoin de persister certaines données comme une base de données (des fichiers de configurations ou de simples fichiers images par exemple). On utilise pour ça les <strong>volumes docker</strong>. De plus, avec <strong>Docker Swarm</strong>, les containers sont volatiles et ne restent pas toujours reliés à un unique serveur. Il faut donc utiliser un <a class="" target="_blank" href="https://docs.docker.com/engine/extend/legacy_plugins/#volume-plugins">volume driver</a>.</p>
<h3>Un espace de stockage flexible</h3>
<p>Afin d’éviter d’éparpiller les données et étendre facilement la taille de notre espace de stockage, j’ai créé une <strong>partition LVM</strong> (Logical Volume Manager) qui combine plusieurs volumes de données. Au fur et à mesure que l’infrastructure grandit, il est possible d’ajouter nos volumes de données à cette partition.</p>
<p>Avec Scaleway, il est très simple d’ajouter et de relier des volumes de données à un serveur. Une fois nos volumes reliés, nous pouvons les combiner ensemble pour former <strong>un seul point de montage</strong>.</p>
<p>L’installation se fait sur notre serveur master :</p>
<div class="relative group"><button type="button" class="invisible group-hover:visible absolute top-0 right-0 rounded-md text-xs bg-gray-300 m-3 p-1.5 cursor-pointer leading-none">Copier</button><pre><code class="language-bash">apt-get install -y lvm2
systemctl start lvm2-lvmetad.socket
pvcreate /dev/{nbd1,nbd2}
vgcreate lvm /dev/nbd1 /dev/nbd2
lvcreate -l 100%FREE -n storage lvm
mkfs -t ext4 /dev/lvm/storage
echo &quot;/dev/mapper/lvm-storage /mnt ext4 rw,relatime 0 0&quot; &gt;&gt; /etc/fstab
mount -a
sed -i -e &#x27;s/use_lvmetad = 1/use_lvmetad = 0/g&#x27; /etc/lvm/lvm.conf
</code></pre></div>
<p>À l’avenir, si vous souhaitez <strong>agrandir votre espace de stockage</strong> via d’autres volumes, il suffit simplement d’exécuter les commandes suivantes :</p>
<div class="relative group"><button type="button" class="invisible group-hover:visible absolute top-0 right-0 rounded-md text-xs bg-gray-300 m-3 p-1.5 cursor-pointer leading-none">Copier</button><pre><code class="language-bash">umount /mnt
vgextend lvm /dev/nbd3
lvextend -l +100%Free /dev/lvm/storage
resize2fs /dev/lvm/storage
mount -a
</code></pre></div>
<h3>Volume driver</h3>
<p>Le <a class="" target="_blank" href="https://docs.docker.com/engine/extend/legacy_plugins/#volume-plugins">volume driver</a> que j’ai choisi s’appelle docker-volume-netshare. Chaque application persistera ses données sur un serveur NFS.</p>
<p>On installe notre <strong>serveur NFS</strong> sur notre master :</p>
<div class="relative group"><button type="button" class="invisible group-hover:visible absolute top-0 right-0 rounded-md text-xs bg-gray-300 m-3 p-1.5 cursor-pointer leading-none">Copier</button><pre><code class="language-bash">sudo apt-get install -y nfs-kernel-server
sudo mkdir /mnt/data
</code></pre></div>
<p>Puis on autorise tous les serveurs à s’y connecter :</p>
<div class="relative group"><button type="button" class="invisible group-hover:visible absolute top-0 right-0 rounded-md text-xs bg-gray-300 m-3 p-1.5 cursor-pointer leading-none">Copier</button><pre><code class="language-bash"># /etc/exports
/mnt/data 127.0.0.1(rw,sync,no_subtree_check,no_root_squash) worker-01.priv.cloud.scaleway.com(rw,sync,no_subtree_check,no_root_squash) worker-02(rw,sync,no_subtree_check,no_root_squash)    
</code></pre></div>
<p>On redémarre notre serveur afin d’appliquer notre configuration :</p>
<div class="relative group"><button type="button" class="invisible group-hover:visible absolute top-0 right-0 rounded-md text-xs bg-gray-300 m-3 p-1.5 cursor-pointer leading-none">Copier</button><pre><code class="language-bash">sudo systemctl restart nfs-kernel-server
</code></pre></div>
<p>Puis on installe sur tous les serveurs le package nfs-common et notre <strong>volume</strong> driver docker-volume-netshare :</p>
<div class="relative group"><button type="button" class="invisible group-hover:visible absolute top-0 right-0 rounded-md text-xs bg-gray-300 m-3 p-1.5 cursor-pointer leading-none">Copier</button><pre><code class="language-bash">sudo apt-get install -y nfs-common
</code></pre></div>
<div class="relative group"><button type="button" class="invisible group-hover:visible absolute top-0 right-0 rounded-md text-xs bg-gray-300 m-3 p-1.5 cursor-pointer leading-none">Copier</button><pre><code class="language-bash">sudo wget -O /usr/bin/docker-volume-netshare https://github.com/ContainX/docker-volume-netshare/releases/download/v0.35/docker-volume-netshare_0.35_linux_amd64-bin
sudo chmod +x /usr/bin/docker-volume-netshare
</code></pre></div>
<p>On crée <strong>un service</strong> docker-volume-netshare qui sera lancé à chaque démarrage serveur :</p>
<div class="relative group"><button type="button" class="invisible group-hover:visible absolute top-0 right-0 rounded-md text-xs bg-gray-300 m-3 p-1.5 cursor-pointer leading-none">Copier</button><pre><code class="language-service"># /etc/systemd/system/docker-volume-netshare.service
[Unit]
Description=Docker NFS, AWS EFS &amp; Samba/CIFS Volume Plugin
Documentation=https://github.com/gondor/docker-volume-netshare
Wants=network-online.target
After=network-online.target
Before=docker.service

[Service]
ExecStart=/usr/bin/docker-volume-netshare nfs
StandardOutput=syslog

[Install]
WantedBy=multi-user.target
</code></pre></div>
<div class="relative group"><button type="button" class="invisible group-hover:visible absolute top-0 right-0 rounded-md text-xs bg-gray-300 m-3 p-1.5 cursor-pointer leading-none">Copier</button><pre><code class="language-bash">systemctl enable docker-volume-netshare.service
systemctl start docker-volume-netshare.service
</code></pre></div>
<p>Pour vérifier si tout fonctionne correctement, vous pouvez créer un volume « test » :</p>
<div class="relative group"><button type="button" class="invisible group-hover:visible absolute top-0 right-0 rounded-md text-xs bg-gray-300 m-3 p-1.5 cursor-pointer leading-none">Copier</button><pre><code class="language-bash">docker volume create --driver nfs --name=test --opt share=127.0.0.1:/mnt/data --opt create=true
</code></pre></div>
<p>Puis créer un fichier « test » depuis un container :</p>
<div class="relative group"><button type="button" class="invisible group-hover:visible absolute top-0 right-0 rounded-md text-xs bg-gray-300 m-3 p-1.5 cursor-pointer leading-none">Copier</button><pre><code class="language-bash">docker run --rm -v test:/mount alpine touch /mount/test
</code></pre></div>
<p>Ce fichier devrait apparaître dans le répertoire /mnt/data de votre serveur master.</p>
<h2>4. Sauvegardes automatisées</h2>
<p><strong>Objectif</strong> : Créer un système de sauvegarde journalier de tous les <strong>volumes</strong>.</p>
<p>Pour sauvegarder nos volumes il nous suffit de sauvegarder notre dossier /mnt/data avec notre outil de backup préféré (borg, restic, duplicity, etc.).</p>
<p>Personnellement j’utilise <strong>restic</strong> :</p>
<div class="relative group"><button type="button" class="invisible group-hover:visible absolute top-0 right-0 rounded-md text-xs bg-gray-300 m-3 p-1.5 cursor-pointer leading-none">Copier</button><pre><code class="language-bash">wget https://github.com/restic/restic/releases/download/v0.9.3/restic_0.9.3_linux_amd64.bz2
bzip2 -d restic_0.9.3_linux_amd64.bz2
mv restic_0.9.3_linux_amd64 /usr/local/bin/restic
chmod +x /usr/local/bin/restic
</code></pre></div>
<p>Le processus de sauvegarde est très simple avec restic :</p>
<div class="relative group"><button type="button" class="invisible group-hover:visible absolute top-0 right-0 rounded-md text-xs bg-gray-300 m-3 p-1.5 cursor-pointer leading-none">Copier</button><pre><code class="language-bash">restic -r &lt;repository&gt; init
restic -r &lt;repository&gt; backup /mnt/data
</code></pre></div>
<p>Il existe plusieurs types de <strong>repository</strong> : local, S3, sftp, rclone, etc. Personnellement j’utilise <strong>S3</strong>, car Scaleway propose un <strong>Object Storage</strong> comme AWS, du coup j’en profite.</p>
<p>On automatise ensuite la sauvegarde avec une <strong>tâche cron</strong> :</p>
<div class="relative group"><button type="button" class="invisible group-hover:visible absolute top-0 right-0 rounded-md text-xs bg-gray-300 m-3 p-1.5 cursor-pointer leading-none">Copier</button><pre><code class="language-bash"># crontab -e
0 0 * * * /usr/local/bin/restic -r &lt;repository&gt; backup /mnt/data
</code></pre></div>
<h3>Restauration</h3>
<p>Dans le cas où vous souhaitez récupérer une sauvegarde précédente :</p>
<div class="relative group"><button type="button" class="invisible group-hover:visible absolute top-0 right-0 rounded-md text-xs bg-gray-300 m-3 p-1.5 cursor-pointer leading-none">Copier</button><pre><code class="language-bash">restic -r &lt;repository&gt; snapshots
restic -r &lt;repository&gt; restore &lt;snapshotID&gt; -t restore
</code></pre></div>
<h2>5. Reverse-proxy et Let’s Encrypt</h2>
<p><strong>Objectif</strong>: Configurer un <strong>reverse proxy</strong> pour accéder à nos applications via un <strong>unique point d’entrée</strong>.</p>
<p>Personnellement, j’utilise <strong>Traefik</strong>, qui est compatible avec <strong>Docker Swarm</strong>.</p>
<p>On crée <strong>un network</strong> que l’on nomme par exemple <strong>traefik-net,</strong> il sera utilisé pour relier de manière automatique chaque application à <strong>Traefik</strong> à l’aide des <strong>labels</strong>.</p>
<div class="relative group"><button type="button" class="invisible group-hover:visible absolute top-0 right-0 rounded-md text-xs bg-gray-300 m-3 p-1.5 cursor-pointer leading-none">Copier</button><pre><code class="language-bash">docker network create --driver=overlay traefik-net
</code></pre></div>
<p>Puis on déploie <strong>Traefik</strong> uniquement sur notre serveur master :</p>
<div class="relative group"><button type="button" class="invisible group-hover:visible absolute top-0 right-0 rounded-md text-xs bg-gray-300 m-3 p-1.5 cursor-pointer leading-none">Copier</button><pre><code class="language-yml"># traefik.yml

version: &quot;3.3&quot;
services:
  traefik:
    image: traefik
    command: --docker \
      --docker.swarmMode \
      --docker.watch
    ports:
      - &quot;80:80&quot;
    volumes:
      - /var/run/docker.sock:/var/run/docker.sock
    deploy:
      placement:
        constraints: [node.role==manager]

networks:
  default:
    external:
      name: traefik-net
</code></pre></div>
<div class="relative group"><button type="button" class="invisible group-hover:visible absolute top-0 right-0 rounded-md text-xs bg-gray-300 m-3 p-1.5 cursor-pointer leading-none">Copier</button><pre><code class="language-bash">docker stack deploy -c traefik.yml traefik
</code></pre></div>
<p>Enfin, pour relier une application à notre <strong>reverse proxy</strong>, on peut créer un <strong>service</strong> docker avec des <strong>labels</strong> qui indiqueront à <strong>Traefik</strong> de diriger le traffic HTTP du domaine <a class="" target="_blank" href="https://johackim.com">johackim.com</a> sur le(s) bon(s) container(s) :</p>
<div class="relative group"><button type="button" class="invisible group-hover:visible absolute top-0 right-0 rounded-md text-xs bg-gray-300 m-3 p-1.5 cursor-pointer leading-none">Copier</button><pre><code class="language-bash">docker service create --name blog --network traefik-net -l traefik.port=2368 -l traefik.frontend.rule=Host:johackim.com -l traefik.enable=true ghost
</code></pre></div>
<h3>Let’s Encrypt</h3>
<p>Pour <strong>automatiser la création de certificats SSL</strong> des services exposés à l’extérieur de mon cluster, j’ai configuré <strong>Traefik</strong> avec ce fichier de configuration :</p>
<div class="relative group"><button type="button" class="invisible group-hover:visible absolute top-0 right-0 rounded-md text-xs bg-gray-300 m-3 p-1.5 cursor-pointer leading-none">Copier</button><pre><code class="language-toml"># traefik.toml

debug = true
logLevel = &quot;DEBUG&quot;
defaultEntryPoints = [&quot;https&quot;,&quot;http&quot;]

[entryPoints]
  [entryPoints.http]
  address = &quot;:80&quot;
    [entryPoints.http.redirect]
    entryPoint = &quot;https&quot;
  [entryPoints.https]
  address = &quot;:443&quot;
    [entryPoints.https.tls]

[acme]
email = &quot;contact@example.com&quot;
storage = &quot;acme.json&quot;
acmeLogging = true
entryPoint = &quot;https&quot;
onHostRule = true

[acme.httpChallenge]
  entryPoint = &quot;http&quot;
</code></pre></div>
<h2>6. Infrastructure as Code</h2>
<p>Toutes les applications sont définies sous forme de code. <strong>Un fichier YAML</strong> représente tout ce que contient une application (<strong>services, volumes, networks</strong>).</p>
<p>Voici comme exemple le fichier ghost.yml que j’utilise pour le déploiement de mon blog :</p>
<div class="relative group"><button type="button" class="invisible group-hover:visible absolute top-0 right-0 rounded-md text-xs bg-gray-300 m-3 p-1.5 cursor-pointer leading-none">Copier</button><pre><code class="language-yml"># ghost.yml

version: &#x27;3&#x27;

services:
  web:
    image: ghost:2.4.0
    volumes:
      - ghost:/var/lib/ghost/content:nocopy
    environment:
      url: ${SCHEME:-http}://${DOMAIN:?err}
    deploy:
      labels:
        traefik.port: 2368
        traefik.frontend.rule: Host:${DOMAIN:?err}
        traefik.enable: &quot;true&quot;

volumes:
  ghost:
    driver: nfs
    driver_opts:
      share: master.priv.cloud.scaleway.com:/mnt/data
      create: &quot;true&quot;

networks:
  default:
    external:
      name: traefik-net
</code></pre></div>
<p>En une seule commande, je peux déployer un blog ghost sous le nom de domaine que je souhaite, et avec un certificat ssl automatiquement attribué :</p>
<div class="relative group"><button type="button" class="invisible group-hover:visible absolute top-0 right-0 rounded-md text-xs bg-gray-300 m-3 p-1.5 cursor-pointer leading-none">Copier</button><pre><code class="language-bash">SCHEME=https DOMAIN=johackim.com docker stack deploy -c ghost.yml blog
</code></pre></div>
<p>J’ai créé d’autres stacks que <strong>Ghost</strong>, je vous invite à vous rendre sur <a class="" target="_blank" href="https://github.com/ethibox/awesome-stacks/">ce repository</a> si vous désirez en voir d’autres.</p>
<h2>7. Monitoring, alerting et logging</h2>
<p>Pour <strong>monitorer</strong> tous mes serveurs, pour être <strong>alerté</strong> à chaque fois qu’une application ne renvoie pas un <strong>code 200</strong> ou qu’un <strong>CPU, RAM, Disque</strong> dépasse les 95% d’utilisation. Je me suis créé une <a class="" target="_blank" href="https://raw.githubusercontent.com/ethibox/awesome-stacks/ee0f0474bb8237b32f1a0a84a12275ed855362d4/monitoring.yml">stack avec grafana, prometheus et alertmanager</a>.</p>
<p><img src="https://i.imgur.com/lO3QlRr.png" alt="Dashboard Grafana"/></p>
<p>Et d’une commande, je peux tout installer :</p>
<div class="relative group"><button type="button" class="invisible group-hover:visible absolute top-0 right-0 rounded-md text-xs bg-gray-300 m-3 p-1.5 cursor-pointer leading-none">Copier</button><pre><code class="language-bash">DOMAIN_GRAFANA=grafana.mondomaine.fr DOMAIN_PROMETHEUS=prometheus.mondomaine.fr docker stack deploy -c monitoring.yml monitoring
</code></pre></div>
<p><a class="" target="_blank" href="https://github.com/ethibox/awesome-stacks/blob/91c336d4c42b3b2dd056a15b65c1d996ce08c236/elastic.yml">La stack elastic</a> quant à elle, va me servir à <strong>logger tout le traffic HTTP entrant</strong> sur <strong>Traefik</strong> et <strong>collecter les syslog</strong> de chaque serveur.</p>
<div class="relative group"><button type="button" class="invisible group-hover:visible absolute top-0 right-0 rounded-md text-xs bg-gray-300 m-3 p-1.5 cursor-pointer leading-none">Copier</button><pre><code class="language-bash">DOMAIN=kibana.mondomaine.fr docker stack deploy -c elastic.yml elastic
</code></pre></div>
<h2>8. Sécurité</h2>
<p>En termes de sécurité, je provisionne tous mes serveurs avec un <a class="" target="_blank" href="https://github.com/johackim/ansible-personal">playbook</a> Ansible. Concrètement, je configure tous mes serveurs avec un <strong>IPS</strong> (fail2ban), un <strong>firewall</strong> (iptables) et des <strong>règles de system hardening</strong>.</p>
<div class="relative group"><button type="button" class="invisible group-hover:visible absolute top-0 right-0 rounded-md text-xs bg-gray-300 m-3 p-1.5 cursor-pointer leading-none">Copier</button><pre><code class="language-bash">ansible-playbook playbook.yml -u root -i &lt;PUBLIC_IP&gt;,
</code></pre></div>
<p>Je crée aussi des règles de sécurité avec les <strong>security group</strong> de Scaleway, puis des <strong>headers HTTP sécurisés</strong> pour chaque application :</p>
<div class="relative group"><button type="button" class="invisible group-hover:visible absolute top-0 right-0 rounded-md text-xs bg-gray-300 m-3 p-1.5 cursor-pointer leading-none">Copier</button><pre><code class="language-bash">docker service update &lt;name_app&gt; --label-add traefik.frontend.headers.customResponseHeaders=&quot;X-XSS-Protection: 1; mode=block&quot;
</code></pre></div>
<h2>Conclusion</h2>
<p>De manière subjective, c’est la solution idéale pour moi, après avoir testé plusieurs solutions (<strong>Kubernetes, Helm, Ark, Ceph, Rook, Minio et Rexray</strong>) c’est celle qui dans mon cas est la plus <strong>accessible, maintenable, scalable</strong> et <strong>performante</strong>.</p>
<p>Sa scalabilité me permet d’<strong>éviter d’investir trop d’argent</strong> dans de très gros serveurs et d’<strong>évoluer proportionnellement</strong> à la demande des clients.</p>
<p>Je pense avoir créé une bonne base, il me reste sûrement encore beaucoup de choses à améliorer, dont par exemple :</p>
<ul>
<li>Ajouter des <strong><a class="" target="_blank" href="https://docs.docker.com/compose/compose-file/#healthcheck">healthcheck</a></strong> et <strong><a class="" target="_blank" href="https://docs.docker.com/config/containers/resource_constraints/">limite de ressource</a></strong> Docker</li>
<li>Me créer un <strong>Siem</strong> avec la stack <strong>Elastic</strong> et <strong>Surricata</strong></li>
<li>Générer de manière aléatoire et automatique les mots de passes dans des <strong>docker secrets</strong>.</li>
<li><strong>Auto-héberger</strong> toute l’infrastucture chez moi sur mon propre matériel, pour ne plus dépendre de <strong>Scaleway</strong>.</li>
<li>Un <strong>stockage distribué</strong></li>
</ul>
<p>N’hésitez pas à me dire dans les commentaires si vous avez des suggestions d’améliorations !</p>
<hr/>
<p>Références :</p>
<ul>
<li>
<a class="" href="/hebergement-web">Hébergement web</a>

</li>
</ul></article><div class="md:px-4"><hr class="border-gray-200 mb-4 mt-8"/><div id="commento"></div></div></div></main><footer class="container m-auto px-4 py-8 flex items-center justify-between flex-wrap lg:max-w-screen-lg text-gray-700"><div><span class="inline-block transform rotate-180">©</span><span class="ml-2">2017-2025</span></div><nav class="grid grid-flow-col gap-2 items-center"><a href="https://x.com/_johackim" aria-label="X" target="_blank" rel="noreferrer"><svg class="h-5 w-5 fill-current hover:text-black" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path d="M18.901 1.153h3.68l-8.04 9.19L24 22.846h-7.406l-5.8-7.584-6.638 7.584H.474l8.6-9.83L0 1.154h7.594l5.243 6.932ZM17.61 20.644h2.039L6.486 3.24H4.298Z"></path></svg></a><a href="https://t.me/johackim" aria-label="Telegram" target="_blank" rel="noreferrer"><svg class="h-5 w-5 fill-current hover:text-black" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path d="M11.944 0A12 12 0 0 0 0 12a12 12 0 0 0 12 12 12 12 0 0 0 12-12A12 12 0 0 0 12 0a12 12 0 0 0-.056 0zm4.962 7.224c.1-.002.321.023.465.14a.506.506 0 0 1 .171.325c.016.093.036.306.02.472-.18 1.898-.962 6.502-1.36 8.627-.168.9-.499 1.201-.82 1.23-.696.065-1.225-.46-1.9-.902-1.056-.693-1.653-1.124-2.678-1.8-1.185-.78-.417-1.21.258-1.91.177-.184 3.247-2.977 3.307-3.23.007-.032.014-.15-.056-.212s-.174-.041-.249-.024c-.106.024-1.793 1.14-5.061 3.345-.48.33-.913.49-1.302.48-.428-.008-1.252-.241-1.865-.44-.752-.245-1.349-.374-1.297-.789.027-.216.325-.437.893-.663 3.498-1.524 5.83-2.529 6.998-3.014 3.332-1.386 4.025-1.627 4.476-1.635z"></path></svg></a><a href="https://mastodon.ethibox.fr/@johackim" aria-label="Mastodon" target="_blank" rel="noreferrer"><svg class="h-5 w-5 fill-current hover:text-black" aria-hidden="true" data-prefix="fab" data-icon="mastodon" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512"><path d="M433 179.11c0-97.2-63.71-125.7-63.71-125.7-62.52-28.7-228.56-28.4-290.48 0 0 0-63.72 28.5-63.72 125.7 0 115.7-6.6 259.4 105.63 289.1 40.51 10.7 75.32 13 103.33 11.4 50.81-2.8 79.32-18.1 79.32-18.1l-1.7-36.9s-36.31 11.4-77.12 10.1c-40.41-1.4-83-4.4-89.63-54a102.54 102.54 0 0 1-.9-13.9c85.63 20.9 158.65 9.1 178.75 6.7 56.12-6.7 105-41.3 111.23-72.9 9.8-49.8 9-121.5 9-121.5zm-75.12 125.2h-46.63v-114.2c0-49.7-64-51.6-64 6.9v62.5h-46.33V197c0-58.5-64-56.6-64-6.9v114.2H90.19c0-122.1-5.2-147.9 18.41-175 25.9-28.9 79.82-30.8 103.83 6.1l11.6 19.5 11.6-19.5c24.11-37.1 78.12-34.8 103.83-6.1 23.71 27.3 18.4 53 18.4 175z"></path></svg></a><a href="https://github.com/johackim" aria-label="Github" target="_blank" rel="noreferrer"><svg class="h-5 w-5 fill-current hover:text-black" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path d="M12 .297c-6.63 0-12 5.373-12 12 0 5.303 3.438 9.8 8.205 11.385.6.113.82-.258.82-.577 0-.285-.01-1.04-.015-2.04-3.338.724-4.042-1.61-4.042-1.61C4.422 18.07 3.633 17.7 3.633 17.7c-1.087-.744.084-.729.084-.729 1.205.084 1.838 1.236 1.838 1.236 1.07 1.835 2.809 1.305 3.495.998.108-.776.417-1.305.76-1.605-2.665-.3-5.466-1.332-5.466-5.93 0-1.31.465-2.38 1.235-3.22-.135-.303-.54-1.523.105-3.176 0 0 1.005-.322 3.3 1.23.96-.267 1.98-.399 3-.405 1.02.006 2.04.138 3 .405 2.28-1.552 3.285-1.23 3.285-1.23.645 1.653.24 2.873.12 3.176.765.84 1.23 1.91 1.23 3.22 0 4.61-2.805 5.625-5.475 5.92.42.36.81 1.096.81 2.22 0 1.606-.015 2.896-.015 3.286 0 .315.21.69.825.57C20.565 22.092 24 17.592 24 12.297c0-6.627-5.373-12-12-12"></path></svg></a><a href="https://linkedin.com/in/johackim" aria-label="LinkedIn" target="_blank" rel="noreferrer"><svg class="h-5 w-5 fill-current hover:text-black" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path d="M20.447 20.452h-3.554v-5.569c0-1.328-.027-3.037-1.852-3.037-1.853 0-2.136 1.445-2.136 2.939v5.667H9.351V9h3.414v1.561h.046c.477-.9 1.637-1.85 3.37-1.85 3.601 0 4.267 2.37 4.267 5.455v6.286zM5.337 7.433c-1.144 0-2.063-.926-2.063-2.065 0-1.138.92-2.063 2.063-2.063 1.14 0 2.064.925 2.064 2.063 0 1.139-.925 2.065-2.064 2.065zm1.782 13.019H3.555V9h3.564v11.452zM22.225 0H1.771C.792 0 0 .774 0 1.729v20.542C0 23.227.792 24 1.771 24h20.451C23.2 24 24 23.227 24 22.271V1.729C24 .774 23.2 0 22.222 0h.003z"></path></svg></a><a href="mailto:contact+blog@johackim.com" aria-label="Mail" target="_blank" rel="noreferrer"><svg class="h-5 w-5 fill-current hover:text-black" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512"><path d="M502.3 190.8c3.9-3.1 9.7-.2 9.7 4.7V400c0 26.5-21.5 48-48 48H48c-26.5 0-48-21.5-48-48V195.6c0-5 5.7-7.8 9.7-4.7 22.4 17.4 52.1 39.5 154.1 113.6 21.1 15.4 56.7 47.8 92.2 47.6 35.7.3 72-32.8 92.3-47.6 102-74.1 131.6-96.3 154-113.7zM256 320c23.2.4 56.6-29.2 73.4-41.4 132.7-96.3 142.8-104.7 173.4-128.7 5.8-4.5 9.2-11.5 9.2-18.9v-19c0-26.5-21.5-48-48-48H48C21.5 64 0 85.5 0 112v19c0 7.4 3.4 14.3 9.2 18.9 30.6 23.9 40.7 32.4 173.4 128.7 16.8 12.2 50.2 41.8 73.4 41.4z"></path></svg></a><a href="/rss.xml" aria-label="RSS" target="_blank" rel="noreferrer"><svg class="h-5 w-5 fill-current hover:text-black" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><circle cx="6.18" cy="17.82" r="2.18"></circle><path d="M4 4.44v2.83c7.03 0 12.73 5.7 12.73 12.73h2.83c0-8.59-6.97-15.56-15.56-15.56zm0 5.66v2.83c3.9 0 7.07 3.17 7.07 7.07h2.83c0-5.47-4.43-9.9-9.9-9.9z"></path></svg></a></nav></footer></div><script id="__NEXT_DATA__" type="application/json">{"props":{"pageProps":{"source":{"compiledSource":"\"use strict\";\nconst {Fragment: _Fragment, jsx: _jsx, jsxs: _jsxs} = arguments[0];\nconst {useMDXComponents: _provideComponents} = arguments[0];\nfunction _createMdxContent(props) {\n  const _components = {\n    a: \"a\",\n    code: \"code\",\n    h2: \"h2\",\n    h3: \"h3\",\n    hr: \"hr\",\n    img: \"img\",\n    li: \"li\",\n    p: \"p\",\n    pre: \"pre\",\n    strong: \"strong\",\n    ul: \"ul\",\n    ..._provideComponents(),\n    ...props.components\n  };\n  return _jsxs(_Fragment, {\n    children: [_jsxs(_components.p, {\n      children: [\"Je me suis récemment donné comme projet de devenir hébergeur indépendant chez les \", _jsx(_components.strong, {\n        children: \"CHATONS\"\n      }), \" (le \", _jsx(_components.strong, {\n        children: \"C\"\n      }), \"ollectif des \", _jsx(_components.strong, {\n        children: \"H\"\n      }), \"ébergeurs \", _jsx(_components.strong, {\n        children: \"A\"\n      }), \"lternatifs, \", _jsx(_components.strong, {\n        children: \"T\"\n      }), \"ransparents, \", _jsx(_components.strong, {\n        children: \"O\"\n      }), \"uverts, \", _jsx(_components.strong, {\n        children: \"N\"\n      }), \"eutres et \", _jsx(_components.strong, {\n        children: \"S\"\n      }), \"olidaires). Étant seul à maintenir les services de mes clients, j’ai dû concevoir une infrastructure \", _jsx(_components.strong, {\n        children: \"sécurisée\"\n      }), \", \", _jsx(_components.strong, {\n        children: \"performante\"\n      }), \", \", _jsx(_components.strong, {\n        children: \"scalable\"\n      }), \", \", _jsx(_components.strong, {\n        children: \"automatisée\"\n      }), \" et \", _jsx(_components.strong, {\n        children: \"facile à maintenir\"\n      }), \". Je vais à travers cet article vous décrire les étapes à suivre pour monter ce type d’infrastructure.\"]\n    }), \"\\n\", _jsx(_components.h2, {\n      children: \"1. Présentation de l'infrastructure\"\n    }), \"\\n\", _jsx(_components.p, {\n      children: \"Dans cette infrastructure, chaque application tourne sous forme d’un ou plusieurs conteneurs répartis sur un ou plusieurs serveurs selon leurs ressources disponibles.\"\n    }), \"\\n\", _jsx(_components.p, {\n      children: _jsx(_components.img, {\n        src: \"https://i.imgur.com/e6l8DD5.png\",\n        alt: \"Infrastructure\"\n      })\n    }), \"\\n\", _jsxs(_components.p, {\n      children: [\"Les \", _jsx(_components.strong, {\n        children: \"conteneurs\"\n      }), \" permettent d’\", _jsx(_components.strong, {\n        children: \"accélérer et faciliter le déploiement des applications\"\n      }), \", ils contiennent toutes les dépendances d’une application et sont indépendants vis-à-vis de l’infrastructure hôte. Additionné à un orchestrateur, par exemple \", _jsx(_components.strong, {\n        children: \"Docker Swarm\"\n      }), \", on dispose d’un système qui exécute, coordonne et \", _jsx(_components.strong, {\n        children: \"gère entièrement le cycle de vie de nos applications\"\n      }), \".\"]\n    }), \"\\n\", _jsxs(_components.p, {\n      children: [\"Aujourd’hui je démarre mon infrastructure avec trois petits serveurs, demain elle pourra \", _jsx(_components.strong, {\n        children: \"évoluer facilement\"\n      }), \" suivant l’augmentation des demandes clients.\"]\n    }), \"\\n\", _jsxs(_components.p, {\n      children: [\"Plutôt que de gérer mon infrastructure sous forme de \", _jsx(_components.strong, {\n        children: \"tâches manuelles et répétitives\"\n      }), \", une grande partie est gérée à l’aide de \", _jsx(_components.strong, {\n        children: \"fichiers de définition\"\n      }), \" que je versionne. Dans mon cas, il s’agit principalement de fichiers \", _jsx(_components.strong, {\n        children: \"YAML\"\n      }), \".\"]\n    }), \"\\n\", _jsxs(_components.p, {\n      children: [\"Si jamais tous mes serveurs venaient à être stoppés ou supprimés inintentionnellement, je peux à priori tout restaurer en moins d’une heure du moment que je dispose des \", _jsx(_components.strong, {\n        children: \"backups\"\n      }), \".\"]\n    }), \"\\n\", _jsx(_components.p, {\n      children: \"Une fois l’infrastructure mise en place, il est possible de démarrer une application en seulement une ligne de commande, par exemple :\"\n    }), \"\\n\", _jsxs(_components.ul, {\n      children: [\"\\n\", _jsxs(_components.li, {\n        children: [\"Un \", _jsx(_components.strong, {\n          children: \"tchat\"\n        }), \" (ex : rocket.chat)\"]\n      }), \"\\n\", _jsxs(_components.li, {\n        children: [\"Un \", _jsx(_components.strong, {\n          children: \"blog\"\n        }), \" (ex : WordPress, Joomla, Ghost)\"]\n      }), \"\\n\", _jsxs(_components.li, {\n        children: [\"Un \", _jsx(_components.strong, {\n          children: \"site e-commerce\"\n        }), \" (ex : PrestaShop)\"]\n      }), \"\\n\", _jsxs(_components.li, {\n        children: [\"Un \", _jsx(_components.strong, {\n          children: \"espace de stockage\"\n        }), \" (ex : ownCloud, Nextcloud)\"]\n      }), \"\\n\", _jsxs(_components.li, {\n        children: [\"Un \", _jsx(_components.strong, {\n          children: \"système de facturation\"\n        }), \" (ex : Invoice Ninja)\"]\n      }), \"\\n\", _jsxs(_components.li, {\n        children: [\"Un \", _jsx(_components.strong, {\n          children: \"système de monitoring et d’alerting\"\n        }), \" (ex : Grafana + Prometheus + Alertmanager)\"]\n      }), \"\\n\"]\n    }), \"\\n\", _jsxs(_components.p, {\n      children: [\"Le tout avec un \", _jsx(_components.strong, {\n        children: \"nom de domaine\"\n      }), \" et un \", _jsx(_components.strong, {\n        children: \"certicat SSL\"\n      }), \" associé automatiquement.\"]\n    }), \"\\n\", _jsx(_components.h2, {\n      children: \"2. Déploiement des serveurs\"\n    }), \"\\n\", _jsxs(_components.p, {\n      children: [\"Aujourd’hui je dispose de \", _jsx(_components.strong, {\n        children: \"trois serveurs Ubuntu Xenial chez Scaleway\"\n      }), \". \", _jsxs(_components.strong, {\n        children: [\"Un serveur \", _jsx(_components.a, {\n          href: \"https://scaleway.com/pricing/#anchor_baremetal\",\n          children: \"C2S\"\n        })]\n      }), \" en tant que master et \", _jsxs(_components.strong, {\n        children: [\"deux serveurs \", _jsx(_components.a, {\n          href: \"https://scaleway.com/pricing/#anchor_starter\",\n          children: \"START1-S\"\n        })]\n      }), \" en tant que workers. Si vous le souhaitez, vous pouvez commencer avec un seul serveur dans un premier temps. De même, il est tout à fait envisageable de créer ce type d’infrastructure sur votre propre matériel physique si vous en avez les moyens.\"]\n    }), \"\\n\", _jsxs(_components.p, {\n      children: [\"Première étape on installe \", _jsx(_components.strong, {\n        children: \"docker\"\n      }), \" sur chaque serveur :\"]\n    }), \"\\n\", _jsx(_components.pre, {\n      children: _jsx(_components.code, {\n        className: \"language-bash\",\n        children: \"apt-get update; apt-get upgrade; apt-get dist-upgrade;\\napt-get install -y apt-transport-https\\ncurl -fsSL https://download.docker.com/linux/ubuntu/gpg | sudo apt-key add -\\nsudo add-apt-repository \\\"deb [arch=amd64] https://download.docker.com/linux/ubuntu $(lsb_release -cs) stable\\\"\\nsudo apt-get update; sudo apt-get install -y docker-ce\\n\"\n      })\n    }), \"\\n\", _jsx(_components.p, {\n      children: \"Ensuite, on initialise Docker Swarm sur le serveur master :\"\n    }), \"\\n\", _jsx(_components.pre, {\n      children: _jsx(_components.code, {\n        className: \"language-bash\",\n        children: \"docker swarm init --advertise-addr eth0:2377\\n\"\n      })\n    }), \"\\n\", _jsx(_components.p, {\n      children: \"Puis, on joint les serveurs workers au serveur master :\"\n    }), \"\\n\", _jsx(_components.pre, {\n      children: _jsx(_components.code, {\n        className: \"language-bash\",\n        children: \"docker swarm join --token \u003ctoken\u003e \u003cmondomaine.priv.cloud.scaleway.com\u003e:2377\\n\"\n      })\n    }), \"\\n\", _jsxs(_components.p, {\n      children: [_jsx(_components.strong, {\n        children: \"Note\"\n      }), \": Scaleway change les adresses IP privées lors du redémarrage des serveurs. Pour cette raison je dois faire communiquer les serveurs entre eux par leurs domaines privés qui eux restent fixes. Si vous ne passez pas par Scaleway vous pouvez utiliser des adresses IP directement.\"]\n    }), \"\\n\", _jsxs(_components.p, {\n      children: [\"Pour la configuration du \", _jsx(_components.strong, {\n        children: \"swap\"\n      }), \", voilà les commandes que j'exécute :\"]\n    }), \"\\n\", _jsx(_components.pre, {\n      children: _jsx(_components.code, {\n        className: \"language-bash\",\n        children: \"fallocate -l 2G /swap\\nmkswap /swap\\necho \\\"/swap  none  swap  sw 0  0\\\" \u003e\u003e /etc/fstab\\nswapon -a\\necho \\\"vm.swappiness = 10\\\" \u003e\u003e /etc/sysctl.d/99-swap.conf\\nsed -i -e 's/GRUB_CMDLINE_LINUX=\\\"\\\"/GRUB_CMDLINE_LINUX=\\\"cgroup_enable=memory swapaccount=1\\\"/g' /etc/default/grub\\nupdate-grub\\n\"\n      })\n    }), \"\\n\", _jsx(_components.h2, {\n      children: \"3. Persistence des données\"\n    }), \"\\n\", _jsxs(_components.p, {\n      children: [\"Une application \", _jsx(_components.strong, {\n        children: \"stateful\"\n      }), \", contrairement à une application stateless, a besoin de persister certaines données comme une base de données (des fichiers de configurations ou de simples fichiers images par exemple). On utilise pour ça les \", _jsx(_components.strong, {\n        children: \"volumes docker\"\n      }), \". De plus, avec \", _jsx(_components.strong, {\n        children: \"Docker Swarm\"\n      }), \", les containers sont volatiles et ne restent pas toujours reliés à un unique serveur. Il faut donc utiliser un \", _jsx(_components.a, {\n        href: \"https://docs.docker.com/engine/extend/legacy_plugins/#volume-plugins\",\n        children: \"volume driver\"\n      }), \".\"]\n    }), \"\\n\", _jsx(_components.h3, {\n      children: \"Un espace de stockage flexible\"\n    }), \"\\n\", _jsxs(_components.p, {\n      children: [\"Afin d’éviter d’éparpiller les données et étendre facilement la taille de notre espace de stockage, j’ai créé une \", _jsx(_components.strong, {\n        children: \"partition LVM\"\n      }), \" (Logical Volume Manager) qui combine plusieurs volumes de données. Au fur et à mesure que l’infrastructure grandit, il est possible d’ajouter nos volumes de données à cette partition.\"]\n    }), \"\\n\", _jsxs(_components.p, {\n      children: [\"Avec Scaleway, il est très simple d’ajouter et de relier des volumes de données à un serveur. Une fois nos volumes reliés, nous pouvons les combiner ensemble pour former \", _jsx(_components.strong, {\n        children: \"un seul point de montage\"\n      }), \".\"]\n    }), \"\\n\", _jsx(_components.p, {\n      children: \"L’installation se fait sur notre serveur master :\"\n    }), \"\\n\", _jsx(_components.pre, {\n      children: _jsx(_components.code, {\n        className: \"language-bash\",\n        children: \"apt-get install -y lvm2\\nsystemctl start lvm2-lvmetad.socket\\npvcreate /dev/{nbd1,nbd2}\\nvgcreate lvm /dev/nbd1 /dev/nbd2\\nlvcreate -l 100%FREE -n storage lvm\\nmkfs -t ext4 /dev/lvm/storage\\necho \\\"/dev/mapper/lvm-storage /mnt ext4 rw,relatime 0 0\\\" \u003e\u003e /etc/fstab\\nmount -a\\nsed -i -e 's/use_lvmetad = 1/use_lvmetad = 0/g' /etc/lvm/lvm.conf\\n\"\n      })\n    }), \"\\n\", _jsxs(_components.p, {\n      children: [\"À l’avenir, si vous souhaitez \", _jsx(_components.strong, {\n        children: \"agrandir votre espace de stockage\"\n      }), \" via d’autres volumes, il suffit simplement d’exécuter les commandes suivantes :\"]\n    }), \"\\n\", _jsx(_components.pre, {\n      children: _jsx(_components.code, {\n        className: \"language-bash\",\n        children: \"umount /mnt\\nvgextend lvm /dev/nbd3\\nlvextend -l +100%Free /dev/lvm/storage\\nresize2fs /dev/lvm/storage\\nmount -a\\n\"\n      })\n    }), \"\\n\", _jsx(_components.h3, {\n      children: \"Volume driver\"\n    }), \"\\n\", _jsxs(_components.p, {\n      children: [\"Le \", _jsx(_components.a, {\n        href: \"https://docs.docker.com/engine/extend/legacy_plugins/#volume-plugins\",\n        children: \"volume driver\"\n      }), \" que j’ai choisi s’appelle docker-volume-netshare. Chaque application persistera ses données sur un serveur NFS.\"]\n    }), \"\\n\", _jsxs(_components.p, {\n      children: [\"On installe notre \", _jsx(_components.strong, {\n        children: \"serveur NFS\"\n      }), \" sur notre master :\"]\n    }), \"\\n\", _jsx(_components.pre, {\n      children: _jsx(_components.code, {\n        className: \"language-bash\",\n        children: \"sudo apt-get install -y nfs-kernel-server\\nsudo mkdir /mnt/data\\n\"\n      })\n    }), \"\\n\", _jsx(_components.p, {\n      children: \"Puis on autorise tous les serveurs à s’y connecter :\"\n    }), \"\\n\", _jsx(_components.pre, {\n      children: _jsx(_components.code, {\n        className: \"language-bash\",\n        children: \"# /etc/exports\\n/mnt/data 127.0.0.1(rw,sync,no_subtree_check,no_root_squash) worker-01.priv.cloud.scaleway.com(rw,sync,no_subtree_check,no_root_squash) worker-02(rw,sync,no_subtree_check,no_root_squash)    \\n\"\n      })\n    }), \"\\n\", _jsx(_components.p, {\n      children: \"On redémarre notre serveur afin d’appliquer notre configuration :\"\n    }), \"\\n\", _jsx(_components.pre, {\n      children: _jsx(_components.code, {\n        className: \"language-bash\",\n        children: \"sudo systemctl restart nfs-kernel-server\\n\"\n      })\n    }), \"\\n\", _jsxs(_components.p, {\n      children: [\"Puis on installe sur tous les serveurs le package nfs-common et notre \", _jsx(_components.strong, {\n        children: \"volume\"\n      }), \" driver docker-volume-netshare :\"]\n    }), \"\\n\", _jsx(_components.pre, {\n      children: _jsx(_components.code, {\n        className: \"language-bash\",\n        children: \"sudo apt-get install -y nfs-common\\n\"\n      })\n    }), \"\\n\", _jsx(_components.pre, {\n      children: _jsx(_components.code, {\n        className: \"language-bash\",\n        children: \"sudo wget -O /usr/bin/docker-volume-netshare https://github.com/ContainX/docker-volume-netshare/releases/download/v0.35/docker-volume-netshare_0.35_linux_amd64-bin\\nsudo chmod +x /usr/bin/docker-volume-netshare\\n\"\n      })\n    }), \"\\n\", _jsxs(_components.p, {\n      children: [\"On crée \", _jsx(_components.strong, {\n        children: \"un service\"\n      }), \" docker-volume-netshare qui sera lancé à chaque démarrage serveur :\"]\n    }), \"\\n\", _jsx(_components.pre, {\n      children: _jsx(_components.code, {\n        className: \"language-service\",\n        children: \"# /etc/systemd/system/docker-volume-netshare.service\\n[Unit]\\nDescription=Docker NFS, AWS EFS \u0026 Samba/CIFS Volume Plugin\\nDocumentation=https://github.com/gondor/docker-volume-netshare\\nWants=network-online.target\\nAfter=network-online.target\\nBefore=docker.service\\n\\n[Service]\\nExecStart=/usr/bin/docker-volume-netshare nfs\\nStandardOutput=syslog\\n\\n[Install]\\nWantedBy=multi-user.target\\n\"\n      })\n    }), \"\\n\", _jsx(_components.pre, {\n      children: _jsx(_components.code, {\n        className: \"language-bash\",\n        children: \"systemctl enable docker-volume-netshare.service\\nsystemctl start docker-volume-netshare.service\\n\"\n      })\n    }), \"\\n\", _jsx(_components.p, {\n      children: \"Pour vérifier si tout fonctionne correctement, vous pouvez créer un volume « test » :\"\n    }), \"\\n\", _jsx(_components.pre, {\n      children: _jsx(_components.code, {\n        className: \"language-bash\",\n        children: \"docker volume create --driver nfs --name=test --opt share=127.0.0.1:/mnt/data --opt create=true\\n\"\n      })\n    }), \"\\n\", _jsx(_components.p, {\n      children: \"Puis créer un fichier « test » depuis un container :\"\n    }), \"\\n\", _jsx(_components.pre, {\n      children: _jsx(_components.code, {\n        className: \"language-bash\",\n        children: \"docker run --rm -v test:/mount alpine touch /mount/test\\n\"\n      })\n    }), \"\\n\", _jsx(_components.p, {\n      children: \"Ce fichier devrait apparaître dans le répertoire /mnt/data de votre serveur master.\"\n    }), \"\\n\", _jsx(_components.h2, {\n      children: \"4. Sauvegardes automatisées\"\n    }), \"\\n\", _jsxs(_components.p, {\n      children: [_jsx(_components.strong, {\n        children: \"Objectif\"\n      }), \" : Créer un système de sauvegarde journalier de tous les \", _jsx(_components.strong, {\n        children: \"volumes\"\n      }), \".\"]\n    }), \"\\n\", _jsx(_components.p, {\n      children: \"Pour sauvegarder nos volumes il nous suffit de sauvegarder notre dossier /mnt/data avec notre outil de backup préféré (borg, restic, duplicity, etc.).\"\n    }), \"\\n\", _jsxs(_components.p, {\n      children: [\"Personnellement j’utilise \", _jsx(_components.strong, {\n        children: \"restic\"\n      }), \" :\"]\n    }), \"\\n\", _jsx(_components.pre, {\n      children: _jsx(_components.code, {\n        className: \"language-bash\",\n        children: \"wget https://github.com/restic/restic/releases/download/v0.9.3/restic_0.9.3_linux_amd64.bz2\\nbzip2 -d restic_0.9.3_linux_amd64.bz2\\nmv restic_0.9.3_linux_amd64 /usr/local/bin/restic\\nchmod +x /usr/local/bin/restic\\n\"\n      })\n    }), \"\\n\", _jsx(_components.p, {\n      children: \"Le processus de sauvegarde est très simple avec restic :\"\n    }), \"\\n\", _jsx(_components.pre, {\n      children: _jsx(_components.code, {\n        className: \"language-bash\",\n        children: \"restic -r \u003crepository\u003e init\\nrestic -r \u003crepository\u003e backup /mnt/data\\n\"\n      })\n    }), \"\\n\", _jsxs(_components.p, {\n      children: [\"Il existe plusieurs types de \", _jsx(_components.strong, {\n        children: \"repository\"\n      }), \" : local, S3, sftp, rclone, etc. Personnellement j’utilise \", _jsx(_components.strong, {\n        children: \"S3\"\n      }), \", car Scaleway propose un \", _jsx(_components.strong, {\n        children: \"Object Storage\"\n      }), \" comme AWS, du coup j’en profite.\"]\n    }), \"\\n\", _jsxs(_components.p, {\n      children: [\"On automatise ensuite la sauvegarde avec une \", _jsx(_components.strong, {\n        children: \"tâche cron\"\n      }), \" :\"]\n    }), \"\\n\", _jsx(_components.pre, {\n      children: _jsx(_components.code, {\n        className: \"language-bash\",\n        children: \"# crontab -e\\n0 0 * * * /usr/local/bin/restic -r \u003crepository\u003e backup /mnt/data\\n\"\n      })\n    }), \"\\n\", _jsx(_components.h3, {\n      children: \"Restauration\"\n    }), \"\\n\", _jsx(_components.p, {\n      children: \"Dans le cas où vous souhaitez récupérer une sauvegarde précédente :\"\n    }), \"\\n\", _jsx(_components.pre, {\n      children: _jsx(_components.code, {\n        className: \"language-bash\",\n        children: \"restic -r \u003crepository\u003e snapshots\\nrestic -r \u003crepository\u003e restore \u003csnapshotID\u003e -t restore\\n\"\n      })\n    }), \"\\n\", _jsx(_components.h2, {\n      children: \"5. Reverse-proxy et Let’s Encrypt\"\n    }), \"\\n\", _jsxs(_components.p, {\n      children: [_jsx(_components.strong, {\n        children: \"Objectif\"\n      }), \": Configurer un \", _jsx(_components.strong, {\n        children: \"reverse proxy\"\n      }), \" pour accéder à nos applications via un \", _jsx(_components.strong, {\n        children: \"unique point d’entrée\"\n      }), \".\"]\n    }), \"\\n\", _jsxs(_components.p, {\n      children: [\"Personnellement, j’utilise \", _jsx(_components.strong, {\n        children: \"Traefik\"\n      }), \", qui est compatible avec \", _jsx(_components.strong, {\n        children: \"Docker Swarm\"\n      }), \".\"]\n    }), \"\\n\", _jsxs(_components.p, {\n      children: [\"On crée \", _jsx(_components.strong, {\n        children: \"un network\"\n      }), \" que l’on nomme par exemple \", _jsx(_components.strong, {\n        children: \"traefik-net,\"\n      }), \" il sera utilisé pour relier de manière automatique chaque application à \", _jsx(_components.strong, {\n        children: \"Traefik\"\n      }), \" à l’aide des \", _jsx(_components.strong, {\n        children: \"labels\"\n      }), \".\"]\n    }), \"\\n\", _jsx(_components.pre, {\n      children: _jsx(_components.code, {\n        className: \"language-bash\",\n        children: \"docker network create --driver=overlay traefik-net\\n\"\n      })\n    }), \"\\n\", _jsxs(_components.p, {\n      children: [\"Puis on déploie \", _jsx(_components.strong, {\n        children: \"Traefik\"\n      }), \" uniquement sur notre serveur master :\"]\n    }), \"\\n\", _jsx(_components.pre, {\n      children: _jsx(_components.code, {\n        className: \"language-yml\",\n        children: \"# traefik.yml\\n\\nversion: \\\"3.3\\\"\\nservices:\\n  traefik:\\n    image: traefik\\n    command: --docker \\\\\\n      --docker.swarmMode \\\\\\n      --docker.watch\\n    ports:\\n      - \\\"80:80\\\"\\n    volumes:\\n      - /var/run/docker.sock:/var/run/docker.sock\\n    deploy:\\n      placement:\\n        constraints: [node.role==manager]\\n\\nnetworks:\\n  default:\\n    external:\\n      name: traefik-net\\n\"\n      })\n    }), \"\\n\", _jsx(_components.pre, {\n      children: _jsx(_components.code, {\n        className: \"language-bash\",\n        children: \"docker stack deploy -c traefik.yml traefik\\n\"\n      })\n    }), \"\\n\", _jsxs(_components.p, {\n      children: [\"Enfin, pour relier une application à notre \", _jsx(_components.strong, {\n        children: \"reverse proxy\"\n      }), \", on peut créer un \", _jsx(_components.strong, {\n        children: \"service\"\n      }), \" docker avec des \", _jsx(_components.strong, {\n        children: \"labels\"\n      }), \" qui indiqueront à \", _jsx(_components.strong, {\n        children: \"Traefik\"\n      }), \" de diriger le traffic HTTP du domaine \", _jsx(_components.a, {\n        href: \"https://johackim.com\",\n        children: \"johackim.com\"\n      }), \" sur le(s) bon(s) container(s) :\"]\n    }), \"\\n\", _jsx(_components.pre, {\n      children: _jsx(_components.code, {\n        className: \"language-bash\",\n        children: \"docker service create --name blog --network traefik-net -l traefik.port=2368 -l traefik.frontend.rule=Host:johackim.com -l traefik.enable=true ghost\\n\"\n      })\n    }), \"\\n\", _jsx(_components.h3, {\n      children: \"Let’s Encrypt\"\n    }), \"\\n\", _jsxs(_components.p, {\n      children: [\"Pour \", _jsx(_components.strong, {\n        children: \"automatiser la création de certificats SSL\"\n      }), \" des services exposés à l’extérieur de mon cluster, j’ai configuré \", _jsx(_components.strong, {\n        children: \"Traefik\"\n      }), \" avec ce fichier de configuration :\"]\n    }), \"\\n\", _jsx(_components.pre, {\n      children: _jsx(_components.code, {\n        className: \"language-toml\",\n        children: \"# traefik.toml\\n\\ndebug = true\\nlogLevel = \\\"DEBUG\\\"\\ndefaultEntryPoints = [\\\"https\\\",\\\"http\\\"]\\n\\n[entryPoints]\\n  [entryPoints.http]\\n  address = \\\":80\\\"\\n    [entryPoints.http.redirect]\\n    entryPoint = \\\"https\\\"\\n  [entryPoints.https]\\n  address = \\\":443\\\"\\n    [entryPoints.https.tls]\\n\\n[acme]\\nemail = \\\"contact@example.com\\\"\\nstorage = \\\"acme.json\\\"\\nacmeLogging = true\\nentryPoint = \\\"https\\\"\\nonHostRule = true\\n\\n[acme.httpChallenge]\\n  entryPoint = \\\"http\\\"\\n\"\n      })\n    }), \"\\n\", _jsx(_components.h2, {\n      children: \"6. Infrastructure as Code\"\n    }), \"\\n\", _jsxs(_components.p, {\n      children: [\"Toutes les applications sont définies sous forme de code. \", _jsx(_components.strong, {\n        children: \"Un fichier YAML\"\n      }), \" représente tout ce que contient une application (\", _jsx(_components.strong, {\n        children: \"services, volumes, networks\"\n      }), \").\"]\n    }), \"\\n\", _jsx(_components.p, {\n      children: \"Voici comme exemple le fichier ghost.yml que j’utilise pour le déploiement de mon blog :\"\n    }), \"\\n\", _jsx(_components.pre, {\n      children: _jsx(_components.code, {\n        className: \"language-yml\",\n        children: \"# ghost.yml\\n\\nversion: '3'\\n\\nservices:\\n  web:\\n    image: ghost:2.4.0\\n    volumes:\\n      - ghost:/var/lib/ghost/content:nocopy\\n    environment:\\n      url: ${SCHEME:-http}://${DOMAIN:?err}\\n    deploy:\\n      labels:\\n        traefik.port: 2368\\n        traefik.frontend.rule: Host:${DOMAIN:?err}\\n        traefik.enable: \\\"true\\\"\\n\\nvolumes:\\n  ghost:\\n    driver: nfs\\n    driver_opts:\\n      share: master.priv.cloud.scaleway.com:/mnt/data\\n      create: \\\"true\\\"\\n\\nnetworks:\\n  default:\\n    external:\\n      name: traefik-net\\n\"\n      })\n    }), \"\\n\", _jsx(_components.p, {\n      children: \"En une seule commande, je peux déployer un blog ghost sous le nom de domaine que je souhaite, et avec un certificat ssl automatiquement attribué :\"\n    }), \"\\n\", _jsx(_components.pre, {\n      children: _jsx(_components.code, {\n        className: \"language-bash\",\n        children: \"SCHEME=https DOMAIN=johackim.com docker stack deploy -c ghost.yml blog\\n\"\n      })\n    }), \"\\n\", _jsxs(_components.p, {\n      children: [\"J’ai créé d’autres stacks que \", _jsx(_components.strong, {\n        children: \"Ghost\"\n      }), \", je vous invite à vous rendre sur \", _jsx(_components.a, {\n        href: \"https://github.com/ethibox/awesome-stacks/\",\n        children: \"ce repository\"\n      }), \" si vous désirez en voir d’autres.\"]\n    }), \"\\n\", _jsx(_components.h2, {\n      children: \"7. Monitoring, alerting et logging\"\n    }), \"\\n\", _jsxs(_components.p, {\n      children: [\"Pour \", _jsx(_components.strong, {\n        children: \"monitorer\"\n      }), \" tous mes serveurs, pour être \", _jsx(_components.strong, {\n        children: \"alerté\"\n      }), \" à chaque fois qu’une application ne renvoie pas un \", _jsx(_components.strong, {\n        children: \"code 200\"\n      }), \" ou qu’un \", _jsx(_components.strong, {\n        children: \"CPU, RAM, Disque\"\n      }), \" dépasse les 95% d’utilisation. Je me suis créé une \", _jsx(_components.a, {\n        href: \"https://raw.githubusercontent.com/ethibox/awesome-stacks/ee0f0474bb8237b32f1a0a84a12275ed855362d4/monitoring.yml\",\n        children: \"stack avec grafana, prometheus et alertmanager\"\n      }), \".\"]\n    }), \"\\n\", _jsx(_components.p, {\n      children: _jsx(_components.img, {\n        src: \"https://i.imgur.com/lO3QlRr.png\",\n        alt: \"Dashboard Grafana\"\n      })\n    }), \"\\n\", _jsx(_components.p, {\n      children: \"Et d’une commande, je peux tout installer :\"\n    }), \"\\n\", _jsx(_components.pre, {\n      children: _jsx(_components.code, {\n        className: \"language-bash\",\n        children: \"DOMAIN_GRAFANA=grafana.mondomaine.fr DOMAIN_PROMETHEUS=prometheus.mondomaine.fr docker stack deploy -c monitoring.yml monitoring\\n\"\n      })\n    }), \"\\n\", _jsxs(_components.p, {\n      children: [_jsx(_components.a, {\n        href: \"https://github.com/ethibox/awesome-stacks/blob/91c336d4c42b3b2dd056a15b65c1d996ce08c236/elastic.yml\",\n        children: \"La stack elastic\"\n      }), \" quant à elle, va me servir à \", _jsx(_components.strong, {\n        children: \"logger tout le traffic HTTP entrant\"\n      }), \" sur \", _jsx(_components.strong, {\n        children: \"Traefik\"\n      }), \" et \", _jsx(_components.strong, {\n        children: \"collecter les syslog\"\n      }), \" de chaque serveur.\"]\n    }), \"\\n\", _jsx(_components.pre, {\n      children: _jsx(_components.code, {\n        className: \"language-bash\",\n        children: \"DOMAIN=kibana.mondomaine.fr docker stack deploy -c elastic.yml elastic\\n\"\n      })\n    }), \"\\n\", _jsx(_components.h2, {\n      children: \"8. Sécurité\"\n    }), \"\\n\", _jsxs(_components.p, {\n      children: [\"En termes de sécurité, je provisionne tous mes serveurs avec un \", _jsx(_components.a, {\n        href: \"https://github.com/johackim/ansible-personal\",\n        children: \"playbook\"\n      }), \" Ansible. Concrètement, je configure tous mes serveurs avec un \", _jsx(_components.strong, {\n        children: \"IPS\"\n      }), \" (fail2ban), un \", _jsx(_components.strong, {\n        children: \"firewall\"\n      }), \" (iptables) et des \", _jsx(_components.strong, {\n        children: \"règles de system hardening\"\n      }), \".\"]\n    }), \"\\n\", _jsx(_components.pre, {\n      children: _jsx(_components.code, {\n        className: \"language-bash\",\n        children: \"ansible-playbook playbook.yml -u root -i \u003cPUBLIC_IP\u003e,\\n\"\n      })\n    }), \"\\n\", _jsxs(_components.p, {\n      children: [\"Je crée aussi des règles de sécurité avec les \", _jsx(_components.strong, {\n        children: \"security group\"\n      }), \" de Scaleway, puis des \", _jsx(_components.strong, {\n        children: \"headers HTTP sécurisés\"\n      }), \" pour chaque application :\"]\n    }), \"\\n\", _jsx(_components.pre, {\n      children: _jsx(_components.code, {\n        className: \"language-bash\",\n        children: \"docker service update \u003cname_app\u003e --label-add traefik.frontend.headers.customResponseHeaders=\\\"X-XSS-Protection: 1; mode=block\\\"\\n\"\n      })\n    }), \"\\n\", _jsx(_components.h2, {\n      children: \"Conclusion\"\n    }), \"\\n\", _jsxs(_components.p, {\n      children: [\"De manière subjective, c’est la solution idéale pour moi, après avoir testé plusieurs solutions (\", _jsx(_components.strong, {\n        children: \"Kubernetes, Helm, Ark, Ceph, Rook, Minio et Rexray\"\n      }), \") c’est celle qui dans mon cas est la plus \", _jsx(_components.strong, {\n        children: \"accessible, maintenable, scalable\"\n      }), \" et \", _jsx(_components.strong, {\n        children: \"performante\"\n      }), \".\"]\n    }), \"\\n\", _jsxs(_components.p, {\n      children: [\"Sa scalabilité me permet d’\", _jsx(_components.strong, {\n        children: \"éviter d’investir trop d’argent\"\n      }), \" dans de très gros serveurs et d’\", _jsx(_components.strong, {\n        children: \"évoluer proportionnellement\"\n      }), \" à la demande des clients.\"]\n    }), \"\\n\", _jsx(_components.p, {\n      children: \"Je pense avoir créé une bonne base, il me reste sûrement encore beaucoup de choses à améliorer, dont par exemple :\"\n    }), \"\\n\", _jsxs(_components.ul, {\n      children: [\"\\n\", _jsxs(_components.li, {\n        children: [\"Ajouter des \", _jsx(_components.strong, {\n          children: _jsx(_components.a, {\n            href: \"https://docs.docker.com/compose/compose-file/#healthcheck\",\n            children: \"healthcheck\"\n          })\n        }), \" et \", _jsx(_components.strong, {\n          children: _jsx(_components.a, {\n            href: \"https://docs.docker.com/config/containers/resource_constraints/\",\n            children: \"limite de ressource\"\n          })\n        }), \" Docker\"]\n      }), \"\\n\", _jsxs(_components.li, {\n        children: [\"Me créer un \", _jsx(_components.strong, {\n          children: \"Siem\"\n        }), \" avec la stack \", _jsx(_components.strong, {\n          children: \"Elastic\"\n        }), \" et \", _jsx(_components.strong, {\n          children: \"Surricata\"\n        })]\n      }), \"\\n\", _jsxs(_components.li, {\n        children: [\"Générer de manière aléatoire et automatique les mots de passes dans des \", _jsx(_components.strong, {\n          children: \"docker secrets\"\n        }), \".\"]\n      }), \"\\n\", _jsxs(_components.li, {\n        children: [_jsx(_components.strong, {\n          children: \"Auto-héberger\"\n        }), \" toute l’infrastucture chez moi sur mon propre matériel, pour ne plus dépendre de \", _jsx(_components.strong, {\n          children: \"Scaleway\"\n        }), \".\"]\n      }), \"\\n\", _jsxs(_components.li, {\n        children: [\"Un \", _jsx(_components.strong, {\n          children: \"stockage distribué\"\n        })]\n      }), \"\\n\"]\n    }), \"\\n\", _jsx(_components.p, {\n      children: \"N’hésitez pas à me dire dans les commentaires si vous avez des suggestions d’améliorations !\"\n    }), \"\\n\", _jsx(_components.hr, {}), \"\\n\", _jsx(_components.p, {\n      children: \"Références :\"\n    }), \"\\n\", _jsxs(_components.ul, {\n      children: [\"\\n\", _jsxs(_components.li, {\n        children: [\"\\n\", _jsx(_components.a, {\n          href: \"/hebergement-web\",\n          title: \"Hébergement web\",\n          children: \"Hébergement web\"\n        }), \"\\n\\n\"]\n      }), \"\\n\"]\n    })]\n  });\n}\nfunction MDXContent(props = {}) {\n  const {wrapper: MDXLayout} = {\n    ..._provideComponents(),\n    ...props.components\n  };\n  return MDXLayout ? _jsx(MDXLayout, {\n    ...props,\n    children: _jsx(_createMdxContent, {\n      ...props\n    })\n  }) : _createMdxContent(props);\n}\nreturn {\n  default: MDXContent\n};\n","frontmatter":{"title":"Mon infrastructure en tant qu'hébergeur web indépendant","permalink":"infrastructure-hebergeur-web-independant","datePublished":"2019-01-01T18:40","dateUpdated":"2019-01-01T18:40","description":"En tant que membre des CHATONS (Collectif des Hébergeurs Alternatifs, Transparents, Ouverts, Neutres et Solidaires) et étant seul à maintenir les services de mes clients, je me suis conçu une infrastructure sécurisée, performante, scalable, automatisée et facile à maintenir.","publish":true,"rss":true},"scope":{}},"isIndex":false,"file":"Mon infrastructure en tant qu'hébergeur web indépendant.md","fileName":"Mon infrastructure en tant qu'hébergeur web indépendant","comments":true,"title":"Mon infrastructure en tant qu'hébergeur web indépendant","permalink":"infrastructure-hebergeur-web-independant","datePublished":"2019-01-01T18:40","dateUpdated":"2019-01-01T18:40","description":"En tant que membre des CHATONS (Collectif des Hébergeurs Alternatifs, Transparents, Ouverts, Neutres et Solidaires) et étant seul à maintenir les services de mes clients, je me suis conçu une infrastructure sécurisée, performante, scalable, automatisée et facile à maintenir.","publish":true,"rss":true},"__N_SSG":true},"page":"/[[...permalink]]","query":{"permalink":["infrastructure-hebergeur-web-independant"]},"buildId":"rai-Pzq2t03wyRHvrWgH-","isFallback":false,"gsp":true,"scriptLoader":[]}</script></body></html>