{"pageProps":{"source":"<div class=\"space-y-4 whitespace-normal *:first:mt-0 *:last:mb-0\"><p>Voici une solution pour pouvoir jouer aux jeux vidéos depuis un environnement <a class=\"\" href=\"/linux\">Linux</a> avec 95% de performance native.</p>\n<p><a class=\"\" target=\"_blank\" href=\"https://youtube.com/watch?v=37D2bRsthfI\">Une vidéo de démonstration par blu3bird84</a></p><h2>Terminologies</h2><p>Avant toute chose, il y a quelques terminologies à connaitre :</p><ul>\n<li><strong>KVM</strong> (Kernel-based Virtual Machine) est le module du noyau Linux qui interagit avec les fonctionnalités de virtualisation du processeur. C&#x27;est un hyperviseur de type I pour Linux.</li>\n<li><strong>QEMU</strong> est le logiciel de virtualisation basé sur KVM qui émule les processeurs virtuels et les périphériques et qui lance et éteint les machines virtuelles.</li>\n<li><strong>virt-manager</strong> est l&#x27;interface graphique qui permet de créer, configurer, et faire tourner les machines virtuelles.</li>\n<li><strong>libvirt</strong> est la bibliothèque qui permet à virt-manager d&#x27;interagir avec les capacités de virtualisation fournies par QEMU.</li>\n<li><strong>virtio</strong> est une interface de programmation qui gère toutes les communications entre l&#x27;hyperviseur et le noyau.</li>\n<li><strong>OVMF</strong> (Open Virtual Machine Firmware) est un projet pour permettre le support de l‘UEFI aux machines virtuelles.</li>\n<li><strong>vfio</strong> Virtual Function I/O</li>\n<li><strong>IOMMU</strong> Unité de gestion de mémoire d&#x27;entrée-sortie</li>\n</ul><h2>Prérequis</h2><ul>\n<li>Avoir deux Carte-graphiques ou 1 Apu et une Carte-graphique</li>\n<li>Votre carte mère doit supporter la technologie IOMMU</li>\n<li>Votre CPU doit supporter la virtualisation matérielle</li>\n<li>Votre carte graphique doit supporter l’UEFI</li>\n<li>Avoir 2 Entrées vidéo sur l&#x27;écran (1 pour le linux (host) et 1 pour la Machine virtuelle (Guest)</li>\n</ul><h2>Installation</h2><p>L&#x27;installation que je propose ici est spécifiquement prévue pour <strong>Arch Linux</strong> ou une distribution basé dessus comme <strong><a class=\"\" target=\"_blank\" href=\"https://antergos.com/\">Antergos</a></strong>. Cette procédure aura pour but d&#x27;installer un environnement <strong>Qemu/KVM + VFIO/IOMMU GPU Passthrough</strong> afin de pouvoir jouer aux jeux depuis Linux sur une <strong>machine virtuelle</strong> Windows.</p><h3>Activer IOMMU</h3><div class=\"relative group\"><button type=\"button\" class=\"invisible group-hover:visible absolute top-0 right-0 rounded-md text-xs bg-gray-300 m-3 p-1.5 cursor-pointer leading-none\">Copier</button><pre><code class=\"language-bash\"># /etc/default/grub\nGRUB_CMDLINE_LINUX_DEFAULT=&quot;quiet splash intel_iommu=on&quot;\n</code></pre></div><div class=\"relative group\"><button type=\"button\" class=\"invisible group-hover:visible absolute top-0 right-0 rounded-md text-xs bg-gray-300 m-3 p-1.5 cursor-pointer leading-none\">Copier</button><pre><code class=\"language-bash\">grub-mkconfig -o /boot/grub/grub.cfg\ndmesg|grep -e DMAR -e IOMMU # Vérifier l&#x27;activation de IOMMU\n</code></pre></div><h3>Installer libvirt, qemu, virt-manager et OVMF</h3><div class=\"relative group\"><button type=\"button\" class=\"invisible group-hover:visible absolute top-0 right-0 rounded-md text-xs bg-gray-300 m-3 p-1.5 cursor-pointer leading-none\">Copier</button><pre><code class=\"language-bash\">pacman -S dnsmasq ebtables dmidecode # libvirt dependencies\npacman -S qemu ovmf virt-manager\npacman -S libvirt\nusermod -aG libvirt username\nsystemctl enable libvirtd\n</code></pre></div><h3>Configurer qemu</h3><div class=\"relative group\"><button type=\"button\" class=\"invisible group-hover:visible absolute top-0 right-0 rounded-md text-xs bg-gray-300 m-3 p-1.5 cursor-pointer leading-none\">Copier</button><pre><code class=\"language-bash\">mv /etc/libvirt/qemu.conf /etc/libvirt/qemu.conf.orig\ncat &lt;&lt;EOT &gt;&gt; /etc/libvirt/qemu.conf\nuser = &quot;root&quot;\ngroup = &quot;root&quot;\nclear_emulator_capabilities = 0\ncgroup_device_acl = [\n    &quot;/dev/null&quot;, &quot;/dev/full&quot;, &quot;/dev/zero&quot;,\n    &quot;/dev/random&quot;, &quot;/dev/urandom&quot;,\n    &quot;/dev/ptmx&quot;, &quot;/dev/kvm&quot;, &quot;/dev/kqemu&quot;,\n    &quot;/dev/rtc&quot;,&quot;/dev/hpet&quot;, &quot;/dev/vfio/vfio&quot;,\n    &quot;/dev/vfio/1&quot;\n]\nnvram = [\n  &quot;/usr/share/ovmf/x64/OVMF_CODE.fd:/usr/share/ovmf/x64/OVMF_VARS.fd&quot;\n]\nEOT\n</code></pre></div><h3>Installer vfio</h3><div class=\"relative group\"><button type=\"button\" class=\"invisible group-hover:visible absolute top-0 right-0 rounded-md text-xs bg-gray-300 m-3 p-1.5 cursor-pointer leading-none\">Copier</button><pre><code class=\"language-bash\">lspci -nn|grep -iP &quot;NVIDIA|Radeon&quot; # $VFIOID\necho options vfio-pci ids=$VFIOID &gt; /etc/modprobe.d/vfio.conf\n\nMODULES=&quot;vfio vfio_iommu_type1 vfio_pci vfio_virqfd&quot; # /etc/mkinitcpio.conf\nmkinitcpio -p linux\n\nlspci -k | grep -i vfio-pci # Check vfio\n</code></pre></div><h3>Installer virtio</h3><div class=\"relative group\"><button type=\"button\" class=\"invisible group-hover:visible absolute top-0 right-0 rounded-md text-xs bg-gray-300 m-3 p-1.5 cursor-pointer leading-none\">Copier</button><pre><code class=\"language-bash\">pacaur -S virtio-win\necho -e &#x27;virtio\\virtio_blk\\virtio_pci\\virtio_net&#x27; | sudo tee /etc/modules-load.d/virtio.conf\nlsmod | grep virtio # Check virtio modules\n</code></pre></div><h2>Configuration de la machine virtuelle</h2><p>Une fois que l&#x27;environnement est prêt, il faut créer et configurer notre machine virtuelle avec <code>virt-manager</code>. Plutôt que de mettre une centaine de screenshots voici une vidéo (en anglais) qui donne étape par étape la configuration de notre machine virtuelle.</p><p><a class=\"\" target=\"_blank\" href=\"https://youtube.com/watch?v=6FI31QDtyy4\">Configuration d&#x27;une machine virtuelle Windows avec virt-manager</a></p><h2>Configuration réseau</h2><p>Pour configurer une connexion réseau sur votre machine virtuelle :</p><ol>\n<li>Edit -&gt; Connection Details -&gt; Virtual Networks -&gt; Add Network</li>\n<li>Create &quot;br0&quot; virtual network with &quot;Forwarding to physical network&quot; option and Physical device wlp59s0</li>\n<li><code>virsh edit &lt;VM_name&gt;</code> and add :</li>\n</ol><div class=\"relative group\"><button type=\"button\" class=\"invisible group-hover:visible absolute top-0 right-0 rounded-md text-xs bg-gray-300 m-3 p-1.5 cursor-pointer leading-none\">Copier</button><pre><code class=\"language-config\">&lt;interface type=&#x27;network&#x27;&gt;\n  &lt;mac address=&#x27;53:54:00:b8:65:3d&#x27;/&gt;\n  &lt;source network=&#x27;br0&#x27;/&gt;\n&lt;/interface&gt;\n</code></pre></div><h2>Ma configuration</h2><p>Si vous avez suivie toutes les étapes, vous devriez avoir votre machine virtuelle prête à l&#x27;emploi pour jouer à vos jeux préférés.</p><p>De mon côté, j&#x27;ai un Laptop, ce qui implique <a class=\"\" target=\"_blank\" href=\"https://gist.github.com/Misairu-G/616f7b2756c488148b7309addc940b28\">une configuration particulière</a>. Pour le moment, je peux seulement lancer ma VM avec un serveur VNC, je n’ai pas réussi à rendre fonctionnelle ma sortie HDMI sur un écran :(.</p><p>Voilà à quoi ressemble ma configuration :</p><div class=\"relative group\"><button type=\"button\" class=\"invisible group-hover:visible absolute top-0 right-0 rounded-md text-xs bg-gray-300 m-3 p-1.5 cursor-pointer leading-none\">Copier</button><pre><code class=\"language-bash\">sudo /usr/sbin/qemu-system-x86_64 \\\n-cpu host,kvm=off \\\n-enable-kvm \\\n-m 4096 \\\n-smp cores=4,threads=2 \\\n-device vfio-pci,host=01:00.0 \\\n-drive if=pflash,format=raw,readonly,file=/usr/share/ovmf/x64/OVMF_CODE.fd \\\n-drive if=pflash,format=raw,file=/usr/share/ovmf/x64/OVMF_VARS.fd \\\n-drive file=/var/lib/libvirt/images/win10.qcow2,format=qcow2,if=none,id=disk0,cache=writeback \\\n-device virtio-blk-pci,scsi=off,bus=pci.0,addr=0x8,drive=disk0,id=virtio-disk0,bootindex=1 \\\n-netdev type=tap,script=no,downscript=no,id=net0,ifname=tap2 \\\n-device virtio-net-pci,netdev=net0,disable-legacy=on,iommu_platform=true,romfile= \\\n-boot menu=on\n</code></pre></div><hr/><p>Références :</p><ul>\n<li>https://wiki.archlinux.org/index.php/PCI_passthrough_via_OVMF</li>\n<li>https://wiki.archlinux.fr/PCI_passthrough_avec_OMVF</li>\n<li>https://medium.com/@dubistkomisch/7c395dde5c2</li>\n<li>https://davidyat.es/2016/09/08/gpu-passthrough/</li>\n<li>https://wiki.installgentoo.com/index.php/PCI_passthrough</li>\n<li>https://clubnix.fr/blog-post/fira/notes-actuelles-sur-le-passthrough-vga</li>\n<li>https://gist.github.com/Misairu-G/616f7b2756c488148b7309addc940b28</li>\n<li>https://linuxserver.io/2017/04/28/how-to-setup-vfio-gpu-passthrough-using-ovmf-and-kvm-on-arch-linux/</li>\n<li>https://docs.fedoraproject.org/quick-docs/en-US/creating-windows-virtual-machines-using-virtio-drivers.html</li>\n<li><a class=\"\" target=\"_blank\" href=\"https://youtu.be/dsDUtzMkxFk\">GrayWolfTech - Play games in Windows on Linux! PCI passthrough quick guide</a></li>\n<li><a class=\"\" target=\"_blank\" href=\"https://youtu.be/6FI31QDtyy4\">Tymscar - Native Performance Windows Games On Linux Quick GPU Passthrough</a></li>\n<li>\n<a title=\"Note bientôt disponible\" class=\"!no-underline border-b-2 border-dotted border-cyan-700\" href=\"/soon?title=Jeux%20vid%C3%A9os\">Jeux vidéos</a>\n\n</li>\n<li>\n<a title=\"Note bientôt disponible\" class=\"!no-underline border-b-2 border-dotted border-cyan-700\" href=\"/soon?title=Qemu\">Qemu</a>\n\n</li>\n</ul></div>","isIndex":false,"file":"Jouer sur Linux avec 95% de performance native.md","fileName":"Jouer sur Linux avec 95% de performance native","title":"Comment jouer sur Linux avec 95% de performance native ?","comments":true,"permalink":"jouer-sur-linux","datePublished":"2018-03-26T05:53","dateUpdated":"2018-03-26T05:53","description":"Voici une solution pour pouvoir jouer aux jeux video depuis un environnement Linux avec 95% de performance native.","aliases":"","publish":true,"rss":true,"note":"88"},"__N_SSG":true}