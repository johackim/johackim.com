{"pageProps":{"source":"<div class=\"space-y-4 whitespace-normal *:first:mt-0 *:last:mb-0\"><p>Sequelize est un ORM Node.js qui permet de créer, éditer et supprimer des données dans une base de données (SQLite, MySQL, PostgreSQL, etc...).</p><p>L&#x27;avantage d&#x27;un ORM, ce que notre code ne dépend pas uniquement d&#x27;un type de de base de donnée.</p><h2>Installation</h2><p>Pour installer sequelize avec SQLite, exécutez la commande suivante :</p><div class=\"relative group\"><button type=\"button\" class=\"invisible group-hover:visible absolute top-0 right-0 rounded-md text-xs bg-gray-300 m-3 p-1.5 cursor-pointer leading-none\">Copier</button><pre><code class=\"language-bash\">yarn add -D sequelize sqlite3\n</code></pre></div><h2>Configuration</h2><p>Créez un fichier <code>models.js</code> avec les détails de votre base de donnée (ex: User).</p><div class=\"relative group\"><button type=\"button\" class=\"invisible group-hover:visible absolute top-0 right-0 rounded-md text-xs bg-gray-300 m-3 p-1.5 cursor-pointer leading-none\">Copier</button><pre><code class=\"language-js\">// models.js\n\nimport { Sequelize, DataTypes } from &#x27;sequelize&#x27;;\n\nconst sequelize = new Sequelize({\n    dialect: &#x27;sqlite&#x27;,\n    storage: `${__dirname}/db.sqlite`,\n    query: { raw: true },\n});\n\nexport const User = sequelize.define(&#x27;User&#x27;, {\n    id: {\n        type: Sequelize.INTEGER,\n        primaryKey: true,\n        autoIncrement: true,\n    },\n    name: {\n        type: DataTypes.STRING,\n    },\n    email: {\n        type: DataTypes.STRING,\n    },\n});\n\nUser.sync();\n</code></pre></div><h2>Selection</h2><p>Pour effectuer une requête de type <code>SELECT</code> :</p><div class=\"relative group\"><button type=\"button\" class=\"invisible group-hover:visible absolute top-0 right-0 rounded-md text-xs bg-gray-300 m-3 p-1.5 cursor-pointer leading-none\">Copier</button><pre><code class=\"language-js\">const users = await User.findAll();\n// ou\nconst user = User.findOne({ where: { name: &#x27;Marty&#x27; } });\n</code></pre></div><h2>Mise à jour</h2><p>Pour mettre à jour des données :</p><div class=\"relative group\"><button type=\"button\" class=\"invisible group-hover:visible absolute top-0 right-0 rounded-md text-xs bg-gray-300 m-3 p-1.5 cursor-pointer leading-none\">Copier</button><pre><code class=\"language-js\">await User.update({ name: &#x27;Biff&#x27; }, { where: { name: &#x27;Marty&#x27; } });\n</code></pre></div><h2>Suppression</h2><p>Pour supprimer des données :</p><div class=\"relative group\"><button type=\"button\" class=\"invisible group-hover:visible absolute top-0 right-0 rounded-md text-xs bg-gray-300 m-3 p-1.5 cursor-pointer leading-none\">Copier</button><pre><code class=\"language-js\">await User.destroy({ force: true, truncate: true, cascade: true });\n</code></pre></div><h2>Création</h2><p>Pour créer un utilisateur dans la table User, exécutez le code Node.js suivant :</p><div class=\"relative group\"><button type=\"button\" class=\"invisible group-hover:visible absolute top-0 right-0 rounded-md text-xs bg-gray-300 m-3 p-1.5 cursor-pointer leading-none\">Copier</button><pre><code class=\"language-js\">await User.create({ name: &#x27;Marty&#x27;, email: &#x27;marty@bttf.com&#x27; });\n</code></pre></div><h2>Relation many-to-many</h2><p>Si par exemple, un utilisateur peut avoir plusieurs livres et qu&#x27;un livre peut appartenir à plusieurs utilisateurs. Il vous faut créer <strong>une association many-to-many</strong> dans votre fichier <code>models.js</code> :</p><div class=\"relative group\"><button type=\"button\" class=\"invisible group-hover:visible absolute top-0 right-0 rounded-md text-xs bg-gray-300 m-3 p-1.5 cursor-pointer leading-none\">Copier</button><pre><code class=\"language-js\">// models.js\n\nexport const Book = sequelize.define(&#x27;book&#x27;, {\n    id: {\n        type: Sequelize.INTEGER,\n        primaryKey: true,\n        autoIncrement: true,\n    },\n    name: { type: DataTypes.STRING },\n});\n\nUser.belongsToMany(Book, { through: &#x27;userBooks&#x27; });\nBook.belongsToMany(User, { through: &#x27;userBooks&#x27; });\n</code></pre></div><p>Cela créera une table intérmédiare <code>userBooks</code>.</p><p>Vous pouvez ensuite créer vos livres de cette manière :</p><div class=\"relative group\"><button type=\"button\" class=\"invisible group-hover:visible absolute top-0 right-0 rounded-md text-xs bg-gray-300 m-3 p-1.5 cursor-pointer leading-none\">Copier</button><pre><code class=\"language-js\">const user = await findOne({ name: &#x27;Marty&#x27; });\nawait user.addBook({ name: &#x27;Back To The Futur&#x27; });\n</code></pre></div><p>Et récupérez vos livres de cette manière :</p><div class=\"relative group\"><button type=\"button\" class=\"invisible group-hover:visible absolute top-0 right-0 rounded-md text-xs bg-gray-300 m-3 p-1.5 cursor-pointer leading-none\">Copier</button><pre><code class=\"language-js\">const books = await User.findAll({ where: { name: &#x27;Marty&#x27; }, include: Book, raw: false });\n</code></pre></div><p>Ou de cette manière :</p><div class=\"relative group\"><button type=\"button\" class=\"invisible group-hover:visible absolute top-0 right-0 rounded-md text-xs bg-gray-300 m-3 p-1.5 cursor-pointer leading-none\">Copier</button><pre><code class=\"language-js\">const books = await User.findAll({ include: { all: true, nested: true }, raw: false });\n</code></pre></div><h2>Relation one-to-many</h2><div class=\"relative group\"><button type=\"button\" class=\"invisible group-hover:visible absolute top-0 right-0 rounded-md text-xs bg-gray-300 m-3 p-1.5 cursor-pointer leading-none\">Copier</button><pre><code class=\"language-js\">User.hasMany(Book);\nBook.belongsTo(User);\n</code></pre></div><h2>Activer le mode debug</h2><p>Si vous voulez voir le détail des requêtes SQL générés, ajouter le paramètre <code>logging</code> à votre fonction, exempl :</p><div class=\"relative group\"><button type=\"button\" class=\"invisible group-hover:visible absolute top-0 right-0 rounded-md text-xs bg-gray-300 m-3 p-1.5 cursor-pointer leading-none\">Copier</button><pre><code class=\"language-js\">const users = await User.findAll({ logging: console.log });\n</code></pre></div><h2>Utiliser des fonctions SQL</h2><p>Si vous avez besoin de faire une recherche avec des fonctions SQL (ex: <code>lower()</code>) :</p><div class=\"relative group\"><button type=\"button\" class=\"invisible group-hover:visible absolute top-0 right-0 rounded-md text-xs bg-gray-300 m-3 p-1.5 cursor-pointer leading-none\">Copier</button><pre><code class=\"language-js\">await User.findAll({\n    where: Sequelize.where(\n        Sequelize.fn(&#x27;lower&#x27;, Sequelize.col(&#x27;name&#x27;)),\n        Sequelize.fn(&#x27;lower&#x27;, name),\n    ),\n});\n</code></pre></div><h2>Définir des champs virtuels</h2><p>Au lieu de créer directement un champ dans la base de donnée, vous pouvez définir des champs virtuels afin de récupérer des valeurs personnalisés :</p><div class=\"relative group\"><button type=\"button\" class=\"invisible group-hover:visible absolute top-0 right-0 rounded-md text-xs bg-gray-300 m-3 p-1.5 cursor-pointer leading-none\">Copier</button><pre><code class=\"language-js\">import { DataTypes } from &#x27;sequelize&#x27;;\n\nconst User = sequelize.define(&#x27;user&#x27;, {\n    firstName: DataTypes.TEXT,\n    lastName: DataTypes.TEXT,\n    fullName: {\n        type: DataTypes.VIRTUAL,\n        get() {\n            return `${this.firstName} ${this.lastName}`;\n        },\n        set(value) {\n            throw new Error(&#x27;Do not try to set the `fullName` value!&#x27;);\n        }\n    }\n});\n</code></pre></div><h2>Exécuter une requête manuelle</h2><div class=\"relative group\"><button type=\"button\" class=\"invisible group-hover:visible absolute top-0 right-0 rounded-md text-xs bg-gray-300 m-3 p-1.5 cursor-pointer leading-none\">Copier</button><pre><code class=\"language-js\">await sequelize.query(&#x27;UPDATE apps SET updatedAt = :updatedAt WHERE id = :id&#x27;, {\n  replacements: { updatedAt, id },\n});\n</code></pre></div></div>","isIndex":false,"file":"Sequelize.md","fileName":"Sequelize","title":"Exécutez facilement vos opérations CRUD avec Sequelize","comments":true,"permalink":"sequelize","datePublished":"2021-12-26T15:44","dateUpdated":"2022-09-12T11:57","publish":true,"rss":true,"note":"73"},"__N_SSG":true}