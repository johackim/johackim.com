{"pageProps":{"source":"<div class=\"space-y-4 whitespace-normal *:first:mt-0 *:last:mb-0\"><p>Cet article est destiné à toutes les personnes souhaitant automatiser l&#x27;envoie de leur newsletter avec de jolis e-mails <strong>responsive</strong> et la possibilité d&#x27;injecter du contenue <strong>dynamiquement</strong> comme les derniers articles d&#x27;un blog.</p><p>Mon blog <a class=\"\" target=\"_blank\" href=\"https://ghost.org/\">ghost</a> permet de stocker les emails des subscribers, mais pas la création ni l&#x27;envoi d&#x27;une <strong>newsletter</strong>. En attendant cette feature, je me suis fait un petit script maison pour <strong>automatiser l&#x27;envoi des 4 derniers articles de mon blog</strong> chaque mois.</p><p>Ce script nodejs va tout simplement parser mon <a class=\"\" target=\"_blank\" href=\"https://johackim.com/rss/\">flux RSS</a> et injecter les articles dans un template <strong>mjml</strong> créé sur <a class=\"\" target=\"_blank\" href=\"https://mjml.io/try-it-live\">mjml.io</a> (framework qui permet de créer très facilement des emails responsive) qui sera envoyé chaque mois aux subscribers de mon blog via <strong>nodemailer</strong>.</p><div class=\"relative group\"><button type=\"button\" class=\"invisible group-hover:visible absolute top-0 right-0 rounded-md text-xs bg-gray-300 m-3 p-1.5 cursor-pointer leading-none\">Copier</button><pre><code class=\"language-javascript\">import nodemailer from &#x27;nodemailer&#x27;;\nimport dotenv from &#x27;dotenv&#x27;;\nimport { mjml2html } from &#x27;mjml&#x27;;\nimport feedparser from &#x27;feedparser-promised&#x27;;\nimport Papa from &#x27;papaparse&#x27;;\nimport fs from &#x27;fs&#x27;;\nimport Newsletter from &#x27;./newsletter&#x27;;\n\ndotenv.config({ silent: true });\n\n(async () =&gt; {\n    const articles = (await feedparser.parse(process.env.FEED_URL)).map(item =&gt; ({\n        title: item.title,\n        href: item.link,\n        tag: item.categories[0],\n        image: item.enclosures[0].url,\n    })).slice(0, process.env.NUMBER_ARTICLES);\n\n    const newsletter = Newsletter(articles);\n    const htmlOutput = mjml2html(newsletter).html;\n\n    if (process.env.NODE_ENV === &#x27;test&#x27;) {\n        fs.writeFileSync(&#x27;newsletter.html&#x27;, htmlOutput);\n        process.exit(0);\n    }\n\n    const transporter = nodemailer.createTransport({\n        port: process.env.MAIL_PORT,\n        host: process.env.MAIL_HOST,\n        tls: process.env.MAIL_TLS,\n        auth: {\n            user: process.env.MAIL_USER,\n            pass: process.env.MAIL_PASS,\n        },\n    });\n\n    const mailOptions = {\n        from: process.env.MAIL_FROM,\n        subject: process.env.MAIL_SUBJECT,\n        html: htmlOutput,\n    };\n\n    const subscribersCsvFile = fs.readFileSync(process.env.SUBSCRIBERS_FILE_PATH).toString();\n    const subscribers = Papa.parse(subscribersCsvFile, { header: true }).data;\n    const emails = subscribers.filter(subscriber =&gt; subscriber.email).map(subscriber =&gt; subscriber.email);\n\n    emails.forEach((email) =&gt; {\n        transporter.sendMail({ ...mailOptions, to: email });\n    });\n})();\n</code></pre></div><p>Les variables d&#x27;environnement à éditer se situent dans le fichier <code>.env</code> :</p><div class=\"relative group\"><button type=\"button\" class=\"invisible group-hover:visible absolute top-0 right-0 rounded-md text-xs bg-gray-300 m-3 p-1.5 cursor-pointer leading-none\">Copier</button><pre><code class=\"language-env\">MAIL_HOST=mail.domain.com\nMAIL_USER=contact@domain.com\nMAIL_PASS=password\nMAIL_PORT=587\nMAIL_FROM=&quot;username &lt;contact@domain.com&gt;&quot;\nMAIL_SUBJECT=&quot;Newsletter&quot;\nMAIL_TLS=true\nFEED_URL=http://domain.com/feed/\nSUBSCRIBERS_FILE_PATH=subscribers.csv\nNUMBER_ARTICLES=4\n</code></pre></div><p>Si vous ne souhaitez pas écrire en dur votre mot de passe dans ce fichier, vous pouvez le déclarer de cette façon :</p><div class=\"relative group\"><button type=\"button\" class=\"invisible group-hover:visible absolute top-0 right-0 rounded-md text-xs bg-gray-300 m-3 p-1.5 cursor-pointer leading-none\">Copier</button><pre><code class=\"language-bash\">MAIL_PASS=password npm start\n</code></pre></div><p>Ce code source est écrit pour un cas spécifique, mais il peut être adapté très facilement selon vos besoins. Il s&#x27;agit ici de seulement 50 lignes de code et d&#x27;un template mjml à adapter. Si vous désirez plus d&#x27;amélioration faite en part dans les commentaires ;).</p><p>Voilà, il est possible de l&#x27;automatiser avec une tâche cron et vous avez une newsletter qui envoie chaque mois les derniers articles de votre blog :</p><div class=\"relative group\"><button type=\"button\" class=\"invisible group-hover:visible absolute top-0 right-0 rounded-md text-xs bg-gray-300 m-3 p-1.5 cursor-pointer leading-none\">Copier</button><pre><code class=\"language-cron\">0 0 1 * * npm start --prefix &lt;PATH_DIRECTORY&gt;\n</code></pre></div><p>Si vous souhaitez simplement tester le rendu de votre newsletter sans envoyer de mails :</p><div class=\"relative group\"><button type=\"button\" class=\"invisible group-hover:visible absolute top-0 right-0 rounded-md text-xs bg-gray-300 m-3 p-1.5 cursor-pointer leading-none\">Copier</button><pre><code class=\"language-bash\">npm test # Generate newsletter.html\n</code></pre></div><p>Le code source est disponible en détails sur <a class=\"\" target=\"_blank\" href=\"https://github.com/johackim/newsletter\">ce dépôt github</a>.</p></div>","isIndex":false,"file":"MJML.md","fileName":"MJML","title":"Automatiser l'envoie d'une newsletter avec mjml et nodemailer","comments":true,"permalink":"automatiser-envoie-newsletter-mjml-nodemailer","datePublished":"2017-11-27T08:00","dateUpdated":"2017-11-27T08:00","description":"Cet article est destiné à toutes les personnes souhaitant automatiser l'envoie de leur newsletter avec de jolis e-mails responsive et la possibilité d'injecter du contenue dynamiquement comme les derniers articles d'un blog.","publish":true,"rss":true,"note":"79"},"__N_SSG":true}