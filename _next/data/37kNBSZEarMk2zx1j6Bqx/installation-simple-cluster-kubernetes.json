{"pageProps":{"source":"<div class=\"space-y-4 whitespace-normal *:first:mt-0 *:last:mb-0\"><p>Vu la popularité du projet (dépôt github le plus discuté avec +350 000 commentaires) et faisant partie du monde des containers, je n&#x27;ai pas pu résister à l&#x27;envie de tester <strong>kubernetes</strong>. Voici deux méthodes pour installer simplement kubernetes. La première est une installation locale avec <a class=\"\" target=\"_blank\" href=\"https://github.com/kubernetes/minikube\">minikube</a>, et la deuxième je l&#x27;ai réalisé sur <a class=\"\" href=\"/comment-creer-son-datacenter-maison\">mon cluster proxmox</a> avec <a class=\"\" target=\"_blank\" href=\"https://github.com/kubernetes/kubeadm\">kubeadm</a>.</p>\n<h2>1. Installation de Minikube</h2><p><strong>NOTE</strong>: Il est <strong>déconseillé</strong> d&#x27;utiliser <strong><a class=\"\" target=\"_blank\" href=\"https://github.com/kubernetes/minikube\">minikube</a></strong> dans un environnement de production, il s&#x27;agit plus d&#x27;une installation à usage personnel sur son laptop afin de tester kubernetes.</p><p>L&#x27;installation est simple, un binaire à télécharger et à exécuter :</p><div class=\"relative group\"><button type=\"button\" class=\"invisible group-hover:visible absolute top-0 right-0 rounded-md text-xs bg-gray-300 m-3 p-1.5 cursor-pointer leading-none\">Copier</button><pre><code class=\"language-bash\">wget -O /usr/local/bin/minikube https://github.com/kubernetes/minikube/releases/download/v0.23.0/minikube-linux-amd64\nchmod +x /usr/local/bin/minikube\n</code></pre></div><p>Une fois installé on démarre notre cluster kubernetes single node en une seule commande, l&#x27;installation se fera à l&#x27;intérieur d&#x27;une VM, personnellement j&#x27;utilise <strong>virtualbox</strong> :</p><div class=\"relative group\"><button type=\"button\" class=\"invisible group-hover:visible absolute top-0 right-0 rounded-md text-xs bg-gray-300 m-3 p-1.5 cursor-pointer leading-none\">Copier</button><pre><code class=\"language-bash\">minikube start --vm-driver=virtualbox\n</code></pre></div><p>On peut déjà jouer avec <strong>kubernetes</strong> et installer un blog ghost par exemple :</p><div class=\"relative group\"><button type=\"button\" class=\"invisible group-hover:visible absolute top-0 right-0 rounded-md text-xs bg-gray-300 m-3 p-1.5 cursor-pointer leading-none\">Copier</button><pre><code class=\"language-bash\">kubectl run ghost --image=ghost\nkubectl expose deployment ghost --type=NodePort --port=80 --target-port=2368\n</code></pre></div><p>L&#x27;accès à celui-ci peut se faire de cette façon :</p><div class=\"relative group\"><button type=\"button\" class=\"invisible group-hover:visible absolute top-0 right-0 rounded-md text-xs bg-gray-300 m-3 p-1.5 cursor-pointer leading-none\">Copier</button><pre><code class=\"language-bash\">export IP=$(minikube ip)\nexport NODE_PORT=$(kubectl get services ghost -o go-template=&#x27;{{(index .spec.ports 0).nodePort}}&#x27;)\ncurl http://$IP:$NODE_PORT\n</code></pre></div><h2>2. Installation de Kubeadm</h2><p>L&#x27;utilisation de <strong><a class=\"\" target=\"_blank\" href=\"https://github.com/kubernetes/kubeadm\">kubeadm</a></strong> est aussi déconseillée en production car <strong>kubeadm</strong> est encore en <strong>bêta</strong>, mais n&#x27;étant pas un géant du web je me le permets quand même. J&#x27;ai déployé plusieurs VM <strong>Ubuntu 16.04 LTS</strong> sur mon cluster proxmox. Une qui fera office de master et les autres de workers. Sans proxmox vous pouvez très bien créer vos machines via vagrant :</p><div class=\"relative group\"><button type=\"button\" class=\"invisible group-hover:visible absolute top-0 right-0 rounded-md text-xs bg-gray-300 m-3 p-1.5 cursor-pointer leading-none\">Copier</button><pre><code class=\"language-bash\">vagrant init ubuntu/xenial64\nvagrant up\n</code></pre></div><p>L&#x27;installation des dépendances d&#x27;un noeud kubernetes (master ou worker) devra s&#x27;effectuer comme suit :</p><div class=\"relative group\"><button type=\"button\" class=\"invisible group-hover:visible absolute top-0 right-0 rounded-md text-xs bg-gray-300 m-3 p-1.5 cursor-pointer leading-none\">Copier</button><pre><code class=\"language-bash\"># Installation des dépendances d&#x27;un noeud kubernete\n\napt-get update &amp;&amp; apt-get install -y apt-transport-https docker.io\necho &quot;deb http://apt.kubernetes.io/ kubernetes-xenial main&quot; &gt;&gt; /etc/apt/sources.list.d/kubernetes.list\ncurl -s https://packages.cloud.google.com/apt/doc/apt-key.gpg | apt-key add -\napt-get update &amp;&amp; apt-get install -y kubelet kubeadm kubernetes-cni\nswapoff -a # Kubernetes ne supporte pas le SWAP\n</code></pre></div><h3>Master node</h3><p>Une fois les dépendances installées et le SWAP désactivé sur chacun des noeuds, nous pouvons installer le master :</p><div class=\"relative group\"><button type=\"button\" class=\"invisible group-hover:visible absolute top-0 right-0 rounded-md text-xs bg-gray-300 m-3 p-1.5 cursor-pointer leading-none\">Copier</button><pre><code class=\"language-bash\">kubeadm init --pod-network-cidr=10.32.0.0/12\n</code></pre></div><p>Il est possible de gérer notre cluster depuis notre PC avec kubectl, il suffit de copier le fichier <code>/etc/kubernetes/admin.conf</code> accessible sur votre noeud master dans votre répertoire <code>$HOME/.kube/config</code>.</p><div class=\"relative group\"><button type=\"button\" class=\"invisible group-hover:visible absolute top-0 right-0 rounded-md text-xs bg-gray-300 m-3 p-1.5 cursor-pointer leading-none\">Copier</button><pre><code class=\"language-bash\">scp root@&lt;master ip&gt;:/etc/kubernetes/admin.conf ~/.kube/config\n</code></pre></div><p>Je suis sur arch linux donc un simple <code>pacaur -S kubectl-bin</code> m&#x27;installe le client, sinon c&#x27;est juste <a class=\"\" target=\"_blank\" href=\"https://kubernetes.io/docs/tasks/tools/install-kubectl/\">un binaire a installer</a>.</p><p>Pour vérifier le bon fonctionnement on peut faire un petit <code>kubectl version</code> depuis notre PC.</p><p>L&#x27;installation d&#x27;un <strong>pod network add-on</strong> est requis, c&#x27;est ce qui va permettre de faire communiquer les <strong>pods</strong> entre eux. Il en existe plusieurs (<a class=\"\" target=\"_blank\" href=\"https://kubernetes.io/docs/setup/independent/create-cluster-kubeadm/#pod-network\">voici la liste</a>), moi j&#x27;utilise <strong>kube-router</strong>.</p><div class=\"relative group\"><button type=\"button\" class=\"invisible group-hover:visible absolute top-0 right-0 rounded-md text-xs bg-gray-300 m-3 p-1.5 cursor-pointer leading-none\">Copier</button><pre><code class=\"language-bash\">kubectl apply -f https://raw.githubusercontent.com/cloudnativelabs/kube-router/master/daemonset/kubeadm-kuberouter.yaml\n</code></pre></div><p>Après quelques secondes le node master devrait être ready (<code>kubectl get nodes</code> pour vérifier).</p><h3>Worker nodes</h3><p>Pour ajouter d&#x27;autres noeuds à notre cluster c&#x27;est très simple, la commande <code>kubeadm init</code> exécutée précédemment à du vous afficher une commande <code>kubeadm join</code> suivit d&#x27;un token qui devrait ressembler à ça :</p><div class=\"relative group\"><button type=\"button\" class=\"invisible group-hover:visible absolute top-0 right-0 rounded-md text-xs bg-gray-300 m-3 p-1.5 cursor-pointer leading-none\">Copier</button><pre><code class=\"language-bash\">kubeadm join --token &lt;TOKEN&gt; &lt;IP&gt;\n</code></pre></div><p>Une fois cette commande exécutée on vérifie encore une fois que le(s) noeud(s) sont correctement ajouté(s) avec <code>kubectl get nodes</code>.</p><p>On peut jouer avec notre cluster et par exemple déployer plusieurs replica de nginx :</p><div class=\"relative group\"><button type=\"button\" class=\"invisible group-hover:visible absolute top-0 right-0 rounded-md text-xs bg-gray-300 m-3 p-1.5 cursor-pointer leading-none\">Copier</button><pre><code class=\"language-bash\">kubectl run ghost --image=nginx\nkubectl scale deployment nginx --replicas=4\nkubectl expose deployment nginx --type=NodePort --port=80 --target-port=80\nexport NODE_PORT=$(kubectl get services nginx -o go-template=&#x27;{{(index .spec.ports 0).nodePort}}&#x27;)\ncurl http://192.168.1.50:$NODE_PORT\n</code></pre></div><h3>(Optionel) Utiliser seulement un noeud</h3><p>Si vous ne voulez pas utiliser d&#x27;autre noeud que le master pour ne pas s&#x27;embêter avec plusieurs VM par exemple c&#x27;est possible :</p><div class=\"relative group\"><button type=\"button\" class=\"invisible group-hover:visible absolute top-0 right-0 rounded-md text-xs bg-gray-300 m-3 p-1.5 cursor-pointer leading-none\">Copier</button><pre><code class=\"language-bash\"># Allow a single-host cluster\nkubectl taint nodes --all node-role.kubernetes.io/master-\n</code></pre></div><p>PS: Si jamais vous avez tout cassé ^^ et que votre cluster ne fonctionne plus vous pouvez reset votre installation avec un <code>kubeadm reset</code>.</p><h2>Conclusion</h2><p>Kubernetes facilite l&#x27;utilisation des containers sur des grosses infrastructures et propose une manière simple de faire de l&#x27;auto-scaling. Ça permet de se concentrer sur le développement et l&#x27;amélioration de son application et moins sur la gestion de ses serveurs.</p><p>Maintenant il me reste d&#x27;autres outils liés à kubernetes à découvrir comme <a class=\"\" target=\"_blank\" href=\"https://draft.sh/\">draft.sh</a>, <a class=\"\" target=\"_blank\" href=\"https://helm.sh/\">helm.sh</a> et <a class=\"\" target=\"_blank\" href=\"https://github.com/fission/fission\">fission</a></p><p>Je n&#x27;ai pas abordé les détails de l&#x27;utilisation de kubernetes, il s&#x27;agit simplement d&#x27;un mini guide d&#x27;installation pour découvrir l&#x27;outil, Si vous souhaitez en savoir davantage sur kubernetes voici quelques ressources qui m&#x27;ont été très utiles sur sa compréhension et son utilisation :</p><p>Un <a class=\"\" target=\"_blank\" href=\"https://kubernetesbootcamp.github.io/kubernetes-bootcamp/\">tutoriel interactif</a> très efficace que je conseille à tous. Et ces deux vidéos, la première est théorique et l&#x27;autre est plus accès sur la pratique.</p><p>Voilà ! Comme d&#x27;habitude si vous avez des questions, suggestions n&#x27;hésitez pas à les soumettre dans les commentaires ! Bon week-end ;)</p><hr/><p>Références :</p><ul>\n<li><a class=\"\" target=\"_blank\" href=\"https://github.com/johackim/dotfiles/blob/d4a5a8f5e3390acf9e4dcbfe441a6447279e0527/.cheat/kubernetes\">Mon aide mémoire des commandes kubernetes</a></li>\n<li><a class=\"\" target=\"_blank\" href=\"https://kubernetes.io/\">https://kubernetes.io/</a></li>\n<li><a class=\"\" target=\"_blank\" href=\"https://github.com/ramitsurana/awesome-kubernetes/\">https://github.com/ramitsurana/awesome-kubernetes/</a></li>\n<li><a class=\"\" target=\"_blank\" href=\"http://kubernetesbyexample.com/\">http://kubernetesbyexample.com/</a></li>\n</ul></div>","isIndex":false,"file":"Installation simple d'un cluster kubernetes.md","fileName":"Installation simple d'un cluster kubernetes","title":"Installation simple d'un cluster kubernetes","comments":true,"permalink":"installation-simple-cluster-kubernetes","datePublished":"2017-11-10T17:52","dateUpdated":"2017-11-10T17:52","description":"Voici deux méthodes pour installer simplement kubernetes. La première est une installation locale avec minikube, et la deuxième je l'ai réalisé sur mon cluster proxmox avec kubeadm.","publish":true,"rss":true,"note":"91"},"__N_SSG":true}